<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>American English Vocabulary</title>

<style>
:root {
  --bg: #fff1f6;
  --card: #ffffff;
  --panel: #ffffff;
  --text: #3b1f2b;
  --muted: #8b6f7a;
  --accent: #db2777;
  --green: #9d174d;
  --border: #f2d5e3;
  --shadow: 0 4px 12px rgba(219,39,119,.08);
}

[data-theme="dark"] {
  --bg: #160a10;
  --card: #1f0b15;
  --panel: #190910;
  --text: #f8e6ee;
  --muted: #c9a4b2;
  --accent: #fb7185;
  --green: #f472b6;
  --border: #3b1423;
  --shadow: 0 4px 12px rgba(0,0,0,.25);
}

* { box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, system-ui, sans-serif;
  margin: 0;
  padding: 40px 20px 60px;
  background: var(--bg);
  color: var(--text);
  transition: background .3s, color .3s;
  text-align: center;
}

h1 { margin: 0 0 20px; font-weight: 700; }

/* ===== –ü–û–ò–°–ö –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===== */
.stats-bar {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  gap: 20px;
  margin-bottom: 20px;
  padding: 0 10px;
  max-width: 680px;
  margin-left: auto;
  margin-right: auto;
}

.stats {
  font-size: 14px;
  color: var(--muted);
  padding: 6px 12px;
  background: var(--panel);
  border-radius: 8px;
  border: 1px solid var(--border);
  white-space: nowrap;
}

.search-container {
  flex: 1;
  max-width: 400px;
  min-width: 250px;
}

#searchInput {
  width: 100%;
  padding: 10px 15px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  font-size: 14px;
  transition: all 0.3s;
}

#searchInput:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(219, 39, 119, 0.1);
}

/* ===== –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===== */
.control-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.test-toggle, .ipa-toggle {
  padding: 8px 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  cursor: pointer;
  box-shadow: var(--shadow);
  font-size: 14px;
  transition: all 0.2s;
}

.test-toggle:hover, .ipa-toggle:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(219,39,119,.15);
}

/* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
.top-bar {
  max-width: 720px;
  margin: 0 auto 24px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 14px;
  box-shadow: var(--shadow);

  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  gap: 14px;
}

.controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 16px;
}

.control-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 13px;
}

#voiceSelect, #voiceSelectSide {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  min-width: 240px;
}

input[type="range"] {
  accent-color: var(--accent);
  width: 140px;
}

/* ===== –ö–ù–û–ü–ö–ò –°–ü–†–ê–í–ê ===== */
.theme-toggle, .settings-toggle {
  position: fixed;
  top: 18px;
  right: 18px;
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  cursor: pointer;
  background: var(--panel);
  color: var(--text);
  box-shadow: 0 2px 8px rgba(219,39,119,.12);
}

.settings-toggle {
  top: 60px;
}

/* ===== –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ===== */
.side-panel {
  position: fixed;
  top: 102px;
  right: 18px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 14px;
  box-shadow: var(--shadow);
  display: none;
  z-index: 10;
  width: 280px;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  opacity: 0;
  transform: translateX(20px);
  transition: opacity 0.3s, transform 0.3s;
}

.side-panel.open {
  opacity: 1;
  transform: translateX(0);
}

/* ===== –ö–ê–†–¢–û–ß–ö–ê ===== */
#container {
  max-width: 680px;
  margin: 0 auto;
}

.card {
  background: var(--card);
  padding: 24px 28px;
  border-radius: 14px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  margin: 0 auto 20px auto;
  text-align: left;
  position: relative;
}

/* ===== –ù–û–ú–ï–† + –ò–ö–û–ù–ö–ò –°–ï–†–í–ò–°–û–í ===== */
.card-index {
  position: absolute;
  top: 12px;
  right: 14px;
  font-size: 12px;
  line-height: 1.3;
  padding-bottom: 8px;
}

.card-index a {
  text-decoration: none;
  margin-right: 4px;
  transition: all 0.2s;
  display: inline-block;
  vertical-align: middle;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∫–æ–Ω–æ–∫ */
.service-icon {
  width: 20px;
  height: 20px;
  object-fit: contain;
  filter: grayscale(50%);
  opacity: 0.5;
  transition: all 0.2s;
  border-radius: 3px;
  background: var(--bg);
  padding: 2px;
  border: 1px solid var(--border);
}

.service-icon:hover {
  filter: grayscale(0%);
  opacity: 1;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.index-num {
  color: var(--text);
  opacity: 0.15;
  margin-left: 8px;
  font-size: 12px;
  vertical-align: middle;
}

/* ===== –ê–ù–ì–õ–ò–ô–°–ö–û–ï –°–õ–û–í–û –ò –ü–ï–†–ï–í–û–î ===== */
.word-line { 
  font-size: 21px; 
  margin-bottom: 14px;
  margin-top: 28px;
}

.word-en {
  color: var(--accent);
  cursor: pointer;
  font-weight: 700;
}

.word-ru {
  cursor: pointer;
}

.en {
  cursor: pointer;
  color: var(--green);
  font-weight: 600;
  margin-bottom: 6px;
}

.ipa {
  font-family: "Lucida Sans Unicode", "Arial Unicode MS", sans-serif;
  color: var(--accent);
  font-size: 13px;
  margin-bottom: 6px;
  padding-left: 10px;
  border-left: 2px solid var(--border);
  font-style: italic;
  opacity: 0.8;
}

.ru {
  cursor: pointer;
  color: var(--muted);
  margin-bottom: 14px;
  padding-left: 6px;
}

.example { margin-bottom: 10px; }

.hide-ru .ru {
  display: none;
}

.hide-ipa .ipa {
  display: none;
}

/* ===== –ü–ê–ì–ò–ù–ê–¶–ò–Ø –ò –°–ß–Å–¢–ß–ò–ö –°–õ–û–í ===== */
.pagination-container {
  margin-top: 30px;
}

.pagination {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 10px;
}

.page-btn {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  cursor: pointer;
}

.page-btn.active {
  background: var(--accent);
  color: white;
}

.word-count {
  font-size: 14px;
  color: var(--muted);
  text-align: center;
}
</style>
</head>

<body>

<button class="theme-toggle" id="themeBtn" onclick="toggleTheme()">üåô</button>
<button class="settings-toggle" id="settingsBtn" onclick="toggleSettings()">üéôÔ∏è</button>

<h1>üá∫üá∏ American English Vocabulary</h1>

<!-- ===== –ü–û–ò–°–ö –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===== -->
<div class="stats-bar">
  <div class="stats" id="totalStats">–í—Å–µ–≥–æ —Å–ª–æ–≤: 0</div>
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ —Å–ª–æ–≤–∞ –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞...">
  </div>
</div>

<!-- ===== –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===== -->
<div class="control-buttons">
  <button class="test-toggle" id="testBtn" onclick="toggleTestMode()">
    üß† –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏
  </button>
  <button class="ipa-toggle" id="ipaBtn" onclick="toggleIpaMode()">
    üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å IPA
  </button>
</div>

<!-- ===== –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ ===== -->
<div class="top-bar">
  <div>
    <label>üéôÔ∏è –ì–æ–ª–æ—Å:</label>
    <select id="voiceSelect"></select>
  </div>

  <div class="controls">
    <div class="control-item">
      <label for="rateSlider">üê¢ –°–∫–æ—Ä–æ—Å—Ç—å ‚Üí üöÄ</label>
      <input id="rateSlider" type="range" min="0.30" max="1.2" step="0.05">
      <span id="rateLabel"></span>
    </div>

    <div class="control-item">
      <label for="pitchSlider">üîä –í—ã—Å–æ—Ç–∞ –≥–æ–ª–æ—Å–∞</label>
      <input id="pitchSlider" type="range" min="0.7" max="1.3" step="0.05">
      <span id="pitchLabel"></span>
    </div>
  </div>
</div>

<!-- ===== –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ===== -->
<div class="side-panel" id="sidePanel">
  <div>
    <label>üéôÔ∏è –ì–æ–ª–æ—Å:</label>
    <select id="voiceSelectSide"></select>
  </div>

  <div class="controls">
    <div class="control-item">
      <label>üê¢ –°–∫–æ—Ä–æ—Å—Ç—å ‚Üí üöÄ</label>
      <input id="rateSliderSide" type="range" min="0.30" max="1.2" step="0.05">
      <span id="rateLabelSide"></span>
    </div>

    <div class="control-item">
      <label>üîä –í—ã—Å–æ—Ç–∞ –≥–æ–ª–æ—Å–∞</label>
      <input id="pitchSliderSide" type="range" min="0.7" max="1.3" step="0.05">
      <span id="pitchLabelSide"></span>
    </div>
  </div>

  <div class="control-buttons">
    <button class="test-toggle" id="testBtnSide" onclick="toggleTestMode()">
      üß† –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏
    </button>
    <button class="ipa-toggle" id="ipaBtnSide" onclick="toggleIpaMode()">
      üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å IPA
    </button>
  </div>
</div>

<div id="container"></div>

<div class="pagination-container">
  <div class="pagination" id="pagination"></div>
  <div class="word-count" id="wordCount"></div>
</div>

<script>
// ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
const PAGE_SIZE = 100;
let allData = [];
let filteredData = [];
let currentPage = 1;
let currentSearch = '';
let showIpa = false; // –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ IPA

// ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê =====
function updateStats() {
  const total = allData.length;
  const filtered = filteredData.length;
  const start = (currentPage - 1) * PAGE_SIZE + 1;
  const end = Math.min(start + PAGE_SIZE - 1, filtered);
  
  document.getElementById('totalStats').textContent = 
    `–í—Å–µ–≥–æ —Å–ª–æ–≤: ${total} (–Ω–∞–π–¥–µ–Ω–æ: ${filtered})`;
  
  document.getElementById('wordCount').textContent = 
    filtered > 0 ? `–ü–æ–∫–∞–∑–∞–Ω—ã —Å–ª–æ–≤–∞ ${start}-${end} –∏–∑ ${filtered}` : '–°–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
}

function applyFilters() {
  filteredData = allData.filter(item => {
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫
    if (currentSearch) {
      const searchLower = currentSearch.toLowerCase();
      const inWord = item.word.toLowerCase().includes(searchLower);
      const inTranslation = item.translation.toLowerCase().includes(searchLower);
      const inExamples = item.examples.some(ex => 
        ex.en.toLowerCase().includes(searchLower) || 
        ex.ru.toLowerCase().includes(searchLower) ||
        (ex.ipa && ex.ipa.toLowerCase().includes(searchLower))
      );
      
      if (!inWord && !inTranslation && !inExamples) return false;
    }
    
    return true;
  });
  
  updateStats();
  renderPage(currentPage);
  buildPagination();
}

// ===== –†–ï–ñ–ò–ú IPA =====
function toggleIpaMode() {
  showIpa = !showIpa;
  document.body.classList.toggle("hide-ipa", !showIpa);
  
  const txt = showIpa
    ? "üôà –°–∫—Ä—ã—Ç—å IPA"
    : "üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å IPA";
  
  document.getElementById("ipaBtn").textContent = txt;
  document.getElementById("ipaBtnSide").textContent = txt;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤ localStorage
  localStorage.setItem("show_ipa", showIpa);
}

// ===== –£–¢–ò–õ–ò–¢–´ –í–´–î–ï–õ–ï–ù–ò–Ø =====
function selectNode(el){
  const range = document.createRange();
  range.selectNodeContents(el);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
}

function selectSingleWordFromEvent(e, el){
  const text = el.textContent;
  const node = el.firstChild;
  if (!node || node.nodeType !== Node.TEXT_NODE) return text.trim();

  const pos = document.caretPositionFromPoint
    ? document.caretPositionFromPoint(e.clientX, e.clientY)
    : null;

  if (!pos || pos.offsetNode !== node) {
    return text.trim().split(/\s+/)[0];
  }

  const i = pos.offset;
  let L = i;
  while (L > 0 && /[\w'-]/.test(text[L-1])) L--;
  let R = i;
  while (R < text.length && /[\w'-]/.test(text[R])) R++;

  const range = document.createRange();
  range.setStart(node, L);
  range.setEnd(node, R);

  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);

  return text.slice(L, R).trim();
}

// ===== –ü–ê–ì–ò–ù–ê–¶–ò–Ø =====
function renderPage(page){
  currentPage = page;
  const container = document.getElementById("container");
  container.innerHTML = "";

  if (filteredData.length === 0) {
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--muted);">üì≠ –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
    updateStats();
    return;
  }

  const start = (page-1) * PAGE_SIZE;
  const slice = filteredData.slice(start, start + PAGE_SIZE);

  slice.forEach((item, i)=>{
    const globalIndex = allData.findIndex(d => d.word === item.word) + 1;

    // –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–≤ –¥–ª—è URL
    const encoded20 = encodeURIComponent(item.word);
    const encodedPlus = item.word.replace(/ /g, '+');
    const encodedUnder = item.word.replace(/ /g, '_');

    // –°—Å—ã–ª–∫–∏ –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã
    const youglish = `https://youglish.com/pronounce/${encodedUnder}/english`;
    const playphrase = `https://www.playphrase.me/#/search?q=${encodedPlus}&language=en`;
    const yandexTrans = `https://translate.yandex.ru/?source_lang=en&target_lang=ru&text=${encoded20}`;
    const transRu = `https://www.translate.ru/–∫–æ–Ω—Ç–µ–∫—Å—Ç—ã/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π-—Ä—É—Å—Å–∫–∏–π/${encoded20}`;
    const kartaslov = `https://en.kartaslov.ru/–ø–µ—Ä–µ–≤–æ–¥-–≤-–∫–æ–Ω—Ç–µ–∫—Å—Ç–µ/${encodedPlus}`;
    const reverso = `https://context.reverso.net/–ø–µ—Ä–µ–≤–æ–¥/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π-—Ä—É—Å—Å–∫–∏–π/${encodedPlus}`;
    const wooordhunt = `https://wooordhunt.ru/word/${encoded20}`;
    const forvo = `https://ru.forvo.com/search/${encoded20}/`;
    const yandexImages = `https://yandex.ru/images/search?text=${encoded20}`;

    const card=document.createElement("div");
    card.className="card";

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤ —Å IPA
    const examplesHTML = item.examples.map(ex => {
      const ipaHTML = ex.ipa ? `<div class="ipa">/${ex.ipa}/</div>` : '';
      return `
        <div class="example">
          <div class="en" data-speak="${ex.en}">${ex.en}</div>
          ${ipaHTML}
          <div class="ru">${ex.ru}</div>
        </div>
      `;
    }).join("");

    card.innerHTML=`
      <div class="card-index">
        <a href="${youglish}" target="_blank" title="YouGlish - –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è –∏–∑ –≤–∏–¥–µ–æ">
          <img src="img/youglish.png" alt="YouGlish" class="service-icon">
        </a>
        <a href="${playphrase}" target="_blank" title="PlayPhrase - —Ñ—Ä–∞–∑—ã –∏–∑ —Ñ–∏–ª—å–º–æ–≤">
          <img src="img/playphrase.png" alt="PlayPhrase" class="service-icon">
        </a>
        <a href="${yandexTrans}" target="_blank" title="–Ø–Ω–¥–µ–∫—Å –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫">
          <img src="img/yandex.png" alt="–Ø–Ω–¥–µ–∫—Å –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫" class="service-icon">
        </a>
        <a href="${transRu}" target="_blank" title="Translate.ru">
          <img src="img/translateru.png" alt="Translate.ru" class="service-icon">
        </a>
        <a href="${kartaslov}" target="_blank" title="Kartaslov - –ø–µ—Ä–µ–≤–æ–¥ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ">
          <img src="img/kartaslov.png" alt="Kartaslov" class="service-icon">
        </a>
        <a href="${reverso}" target="_blank" title="Reverso Context">
          <img src="img/reverso.png" alt="Reverso" class="service-icon">
        </a>
        <a href="${wooordhunt}" target="_blank" title="WooordHunt">
          <img src="img/wooordhunt.png" alt="WooordHunt" class="service-icon">
        </a>
        <a href="${forvo}" target="_blank" title="Forvo - –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ –æ—Ç –Ω–æ—Å–∏—Ç–µ–ª–µ–π">
          <img src="img/forvo.png" alt="Forvo" class="service-icon">
        </a>
        <a href="${yandexImages}" target="_blank" title="–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∏–Ω–∫–∏">
          <img src="img/yandex-images.png" alt="–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∏–Ω–∫–∏" class="service-icon">
        </a>
        <span class="index-num">${globalIndex}</span>
      </div>

      <div class="word-line">
        <span class="word-en" data-speak="${item.word}">${item.word}</span>
        ‚Äì
        <span class="word-ru">${item.translation}</span>
      </div>

      <div class="examples">
        ${examplesHTML}
      </div>
    `;
    container.appendChild(card);
  });

  // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –æ–∑–≤—É—á–∫–∏
  document.querySelectorAll(".word-en, .en").forEach(el=>{
    el.onclick = e => {
      selectNode(el);
      speakText(el.dataset.speak);
    };

    el.ondblclick = e => {
      e.preventDefault();
      e.stopPropagation();
      const w = selectSingleWordFromEvent(e, el);
      speakText(w);
    };
  });

  document.querySelectorAll(".word-ru, .ru")
    .forEach(el=> el.onclick = ()=> selectNode(el));

  updateStats();
  updatePaginationUI();
}

function buildPagination(){
  const total = Math.ceil(filteredData.length / PAGE_SIZE);
  const pag = document.getElementById("pagination");
  pag.innerHTML="";

  for(let i=1;i<=total;i++){
    const b=document.createElement("button");
    b.textContent=i;
    b.className="page-btn";
    b.onclick=()=>renderPage(i);
    pag.appendChild(b);
  }
}

function updatePaginationUI(){
  document.querySelectorAll(".page-btn")
    .forEach(btn=>{
      btn.classList.toggle("active", btn.textContent==currentPage);
    });
}

// ===== –†–ï–ñ–ò–ú –°–ê–ú–û–ü–†–û–í–ï–†–ö–ò =====
let testMode = false;
function toggleTestMode(){
  testMode = !testMode;
  document.body.classList.toggle("hide-ru", testMode);
  const txt = testMode
    ? "üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã"
    : "üß† –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏";
  document.getElementById("testBtn").textContent = txt;
  document.getElementById("testBtnSide").textContent = txt;
}

// ===== –¢–ï–ú–ê =====
const saved = localStorage.getItem("theme");
if (saved) document.documentElement.setAttribute("data-theme", saved);

function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme");
  const next = cur === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("theme", next);
}

// ===== –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ =====
let isSettingsOpen = false;
function toggleSettings(){
  const panel = document.getElementById("sidePanel");
  if (isSettingsOpen) {
    panel.classList.remove("open");
    setTimeout(() => panel.style.display = "none", 300);
  } else {
    panel.style.display = "flex";
    setTimeout(() => panel.classList.add("open"), 10);
  }
  isSettingsOpen = !isSettingsOpen;
}

// ===== –ü–û–õ–ó–£–ù–ö–ò + –ü–û–î–ü–ò–°–ò =====
const rateSlider = document.getElementById("rateSlider");
const pitchSlider = document.getElementById("pitchSlider");
const rateLabel = document.getElementById("rateLabel");
const pitchLabel = document.getElementById("pitchLabel");

const rateSliderSide = document.getElementById("rateSliderSide");
const pitchSliderSide = document.getElementById("pitchSliderSide");
const rateLabelSide = document.getElementById("rateLabelSide");
const pitchLabelSide = document.getElementById("pitchLabelSide");

rateSlider.value = localStorage.getItem("tts_rate") || 0.9;
pitchSlider.value = localStorage.getItem("tts_pitch") || 1.02;
rateSliderSide.value = rateSlider.value;
pitchSliderSide.value = pitchSlider.value;

function updateLabels(){
  rateLabel.textContent = `x${parseFloat(rateSlider.value).toFixed(2)}`;
  pitchLabel.textContent = parseFloat(pitchSlider.value).toFixed(2);
  rateLabelSide.textContent = `x${parseFloat(rateSliderSide.value).toFixed(2)}`;
  pitchLabelSide.textContent = parseFloat(pitchSliderSide.value).toFixed(2);
}
updateLabels();

rateSlider.oninput = () => {
  rateSliderSide.value = rateSlider.value;
  localStorage.setItem("tts_rate", rateSlider.value);
  updateLabels();
};

pitchSlider.oninput = () => {
  pitchSliderSide.value = pitchSlider.value;
  localStorage.setItem("tts_pitch", pitchSlider.value);
  updateLabels();
};

rateSliderSide.oninput = () => {
  rateSlider.value = rateSliderSide.value;
  localStorage.setItem("tts_rate", rateSlider.value);
  updateLabels();
};

pitchSliderSide.oninput = () => {
  pitchSlider.value = pitchSliderSide.value;
  localStorage.setItem("tts_pitch", pitchSlider.value);
  updateLabels();
};

// ===== –ì–û–õ–û–°–ê =====
const voiceSelect = document.getElementById("voiceSelect");
const voiceSelectSide = document.getElementById("voiceSelectSide");
let VOICES = [];

const NAME_MAP = {
  "Ava":"Ava","Nathan":"Nathan","Alex":"–ê–ª–µ–∫—Å","–ê–ª–µ–∫—Å":"–ê–ª–µ–∫—Å",
  "Zoe":"–ó–æ–∏","–ó–æ–∏":"–ó–æ–∏","Nikki":"–ù–∏–∫–∫–∏","Nicky":"–ù–∏–∫–∫–∏",
  "–ù–∏–∫–∫–∏":"–ù–∏–∫–∫–∏","Samantha":"–°–∞–º–∞–Ω—Ç–∞","–°–∞–º–∞–Ω—Ç–∞":"–°–∞–º–∞–Ω—Ç–∞",
  "Susan":"–°—å—é–∑–µ–Ω","–°—å—é–∑–µ–Ω":"–°—å—é–∑–µ–Ω","Tom":"–¢–æ–º","–¢–æ–º":"–¢–æ–º",
  "Evan":"–≠–≤–∞–Ω","–≠–≤–∞–Ω":"–≠–≤–∞–Ω","Alison":"–≠–ª–∏—Å–æ–Ω","–≠–ª–∏—Å–æ–Ω":"–≠–ª–∏—Å–æ–Ω"
};

const GENDER_ICON = {
  "–¢–æ–º":"üë®","–≠–≤–∞–Ω":"üë®","Nathan":"üë®","–ê–ª–µ–∫—Å":"üë®",
  "–ù–∏–∫–∫–∏":"üë©","–°–∞–º–∞–Ω—Ç–∞":"üë©","–ó–æ–∏":"üë©","Ava":"üë©",
  "–°—å—é–∑–µ–Ω":"üë©","–≠–ª–∏—Å–æ–Ω":"üë©"
};

const DISPLAY_ORDER = [
  "–¢–æ–º","–≠–≤–∞–Ω","Nathan","–ê–ª–µ–∫—Å","SEPARATOR",
  "–ù–∏–∫–∫–∏","–°–∞–º–∞–Ω—Ç–∞","–ó–æ–∏","Ava","–°—å—é–∑–µ–Ω","–≠–ª–∏—Å–æ–Ω"
];

window.addEventListener("load", () => {
  const warmup = new SpeechSynthesisUtterance(" ");
  warmup.volume = 0;
  window.speechSynthesis.speak(warmup);
  setTimeout(populateVoices,300);
  setTimeout(populateVoices,800);
  setTimeout(populateVoices,1500);
});
window.speechSynthesis.onvoiceschanged = populateVoices;

function populateVoices(){
  const allVoices = window.speechSynthesis.getVoices();
  if (!allVoices.length) return;

  const matched = allVoices.filter(v =>
    v.lang==="en-US" &&
    Object.keys(NAME_MAP).some(k=>v.name.includes(k))
  );

  VOICES = matched;
  voiceSelect.innerHTML = "";
  voiceSelectSide.innerHTML = "";

  const items = VOICES.map((v,i)=>{
    const short =
      Object.entries(NAME_MAP).find(([k])=>v.name.includes(k))?.[1] || v.name;
    const icon = GENDER_ICON[short] || "";
    return {index:i,label:icon?`${icon} ${short}`:short,short};
  });

  DISPLAY_ORDER.forEach(name=>{
    if(name==="SEPARATOR"){
      const s = document.createElement("option");
      s.textContent="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
      s.disabled=true;
      voiceSelect.appendChild(s);
      voiceSelectSide.appendChild(s.cloneNode(true));
      return;
    }
    const f = items.find(it=>it.short===name);
    if(f){
      const o = document.createElement("option");
      o.value = f.index;
      o.textContent = f.label;
      voiceSelect.appendChild(o);
      voiceSelectSide.appendChild(o.cloneNode(true));
    }
  });

  const mute = document.createElement("option");
  mute.value="mute";
  mute.textContent="üîá –ë–µ–∑ –æ–∑–≤—É—á–∫–∏";
  voiceSelect.appendChild(mute);
  voiceSelectSide.appendChild(mute.cloneNode(true));

  const savedVoice = localStorage.getItem("tts_voice");
  const tom = VOICES.findIndex(v=>v.name.includes("Tom"));
  const def = tom!==-1 ? tom : "mute";

  voiceSelect.value = savedVoice || def;
  voiceSelectSide.value = savedVoice || def;
}

voiceSelect.onchange = () => {
  voiceSelectSide.value = voiceSelect.value;
  localStorage.setItem("tts_voice", voiceSelect.value);
};
voiceSelectSide.onchange = () => {
  voiceSelect.value = voiceSelectSide.value;
  localStorage.setItem("tts_voice", voiceSelect.value);
};

// ===== TTS =====
function speakText(text){
  if(voiceSelect.value==="mute") return;

  const synth = window.speechSynthesis;
  synth.cancel();

  const idx = parseInt(voiceSelect.value,10);
  const voice = VOICES[idx] || VOICES[0];

  const u = new SpeechSynthesisUtterance(text);
  u.voice = voice;
  u.lang = "en-US";
  u.rate = parseFloat(rateSlider.value);
  u.pitch = parseFloat(pitchSlider.value);
  u.volume = 1.0;
  synth.speak(u);
}

// ===== –ü–û–ò–°–ö =====
document.getElementById('searchInput').addEventListener('input', function(e) {
  currentSearch = e.target.value.trim();
  currentPage = 1;
  applyFilters();
});

// ===== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• =====
fetch("data.json")
  .then(r=>r.json())
  .then(data=>{
    allData = data;
    filteredData = [...allData];
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É IPA –∏–∑ localStorage
    const savedIpa = localStorage.getItem("show_ipa");
    if (savedIpa !== null) {
      showIpa = savedIpa === "true";
      document.body.classList.toggle("hide-ipa", !showIpa);
      
      const txt = showIpa
        ? "üôà –°–∫—Ä—ã—Ç—å IPA"
        : "üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å IPA";
      
      document.getElementById("ipaBtn").textContent = txt;
      document.getElementById("ipaBtnSide").textContent = txt;
    }
    
    updateStats();
    renderPage(1);
    buildPagination();
  })
  .catch(err => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
    document.getElementById('container').innerHTML = 
      '<div style="text-align: center; padding: 40px; color: var(--muted);">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ data.json</div>';
  });
</script>

</body>
</html>
