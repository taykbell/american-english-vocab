<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>American English Vocabulary</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
    --bg: #fff1f6;
    --card: #ffffff;
    --panel: #ffffff;
    --text: #3b1f2b;
    --muted: #8b6f7a;
    --accent: #db2777;
    --green: #9d174d;
    --border: #f2d5e3;
    --shadow: 0 4px 12px rgba(219,39,119,.08);
    --example-bg: rgba(251, 113, 133, 0.05);
}
[data-theme="dark"] {
    --bg: #160a10;
    --card: #1f0b15;
    --panel: #190910;
    --text: #f8e6ee;
    --muted: #c9a4b2;
    --accent: #fb7185;
    --green: #f472b6;
    --border: #3b1423;
    --shadow: 0 4px 12px rgba(0,0,0,.25);
    --example-bg: rgba(251, 113, 133, 0.08);
}
* { box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, system-ui, sans-serif;
    margin: 0;
    padding: 40px 20px 60px;
    background: var(--bg);
    color: var(--text);
    transition: background .3s, color .3s;
    text-align: center;
}
h1 { margin: 0 0 8px; font-weight: 700; font-size: 2rem; }
.header-subtitle {
    color: var(--muted);
    font-size: 0.95rem;
    margin-bottom: 20px;
}
/* ===== –°–ï–ö–¶–ò–Ø –ü–û–ò–°–ö–ê ===== */
.search-section {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    max-width: 720px;
    margin-left: auto;
    margin-right: auto;
}
.search-section .stats {
    font-size: 14px;
    color: var(--muted);
    padding: 6px 12px;
    background: var(--panel);
    border-radius: 8px;
    border: 1px solid var(--border);
}
.search-container {
    flex: 1;
    max-width: 400px;
    min-width: 250px;
}
#searchInput {
    width: 100%;
    padding: 10px 15px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--panel);
    color: var(--text);
    font-size: 14px;
    transition: all 0.3s;
}
#searchInput:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(219,39,119,0.1);
}
/* ===== –°–ï–ö–¶–ò–Ø –ë–´–°–¢–†–û–ì–û –ü–ï–†–ï–•–û–î–ê ===== */
.card-jump-section {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto 20px;
    max-width: 720px;
}
.card-jump-container {
    display: flex;
    align-items: center;
    gap: 0;
    width: 100%;
    max-width: 400px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 4px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
}
.card-jump-container:hover {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(219, 39, 119, 0.1);
}
.card-jump-icon {
    padding: 0 12px;
    color: var(--muted);
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.card-jump-input {
    flex: 1;
    padding: 10px 12px;
    border: none;
    border-radius: 8px;
    background: transparent;
    color: var(--text);
    font-size: 14px;
    outline: none;
    transition: all 0.2s;
}
.card-jump-input:focus {
    background: rgba(219, 39, 119, 0.05);
}
.card-jump-btn {
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    background: var(--accent);
    color: white;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}
.card-jump-btn:hover {
    background: var(--green);
    transform: translateY(-1px);
}
/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
@keyframes fadeInOut {
    0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    10% { opacity: 1; transform: translateX(-50%) translateY(0); }
    90% { opacity: 1; transform: translateX(-50%) translateY(0); }
    100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
}
/* ===== –°–ï–ö–¶–ò–Ø –§–ò–õ–¨–¢–†–û–í ===== */
.filter-section {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin: 0 auto 20px;
    max-width: 720px;
    box-shadow: var(--shadow);
}
.filter-section h3 {
    margin: 0 0 12px;
    font-size: 16px;
    color: var(--accent);
    text-align: left;
    padding-left: 8px;
}
.filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: space-between;
    align-items: flex-start;
}
.filter-container {
    flex: 1;
    min-width: 200px;
}
.filter-container label {
    display: block;
    margin-bottom: 6px;
    font-size: 13px;
    color: var(--muted);
    font-weight: 500;
    text-align: left;
}
#tagFilter, #themeFilter {
    width: 100%;
    padding: 10px 15px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--panel);
    color: var(--text);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}
#tagFilter:hover, #themeFilter:hover {
    border-color: var(--accent);
}
#tagFilter:focus, #themeFilter:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(219,39,119,0.1);
}
#tagFilter[multiple] {
    height: auto;
    min-height: 44px;
    max-height: 200px;
    overflow-y: auto;
}
#tagFilter option {
    padding: 8px 12px;
    cursor: pointer;
}
#tagFilter option:hover {
    background-color: var(--accent);
    color: white;
}
.selected-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}
.tag-badge {
    background: var(--accent);
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    transition: all 0.2s;
}
.tag-badge:hover {
    background: var(--green);
    transform: translateY(-1px);
}
.tag-count {
    font-size: 10px;
    opacity: 0.9;
    background: rgba(255, 255, 255, 0.2);
    padding: 1px 4px;
    border-radius: 8px;
    margin-left: 4px;
}
.remove-tag {
    font-size: 14px;
    line-height: 1;
    margin-left: 3px;
}
.filter-stats {
    font-size: 11px;
    color: var(--muted);
    margin-top: 4px;
    text-align: left;
}
.clear-filters {
    padding: 8px 14px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--panel);
    color: var(--text);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    white-space: nowrap;
    margin-top: 12px;
}
.clear-filters:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}
/* –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.filter-container.active-filter {
    position: relative;
}
.filter-container.active-filter::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background-color: var(--accent);
    border-radius: 2px 2px 0 0;
}
.filter-container.active-filter label {
    color: var(--accent);
    font-weight: 600;
}
/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
.word-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 15px;
    margin-top: 10px;
}
.word-tag {
    background: rgba(219, 39, 119, 0.1);
    color: var(--accent);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    border: 1px solid rgba(219, 39, 119, 0.2);
    cursor: pointer;
    transition: all 0.2s;
}
.word-tag:hover {
    background: rgba(219, 39, 119, 0.2);
    transform: translateY(-1px);
}
/* ===== –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===== */
.control-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin: 0 auto 20px;
    max-width: 720px;
    flex-wrap: wrap;
}
/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ */
.control-buttons button,
.side-panel .control-buttons button {
    padding: 10px 18px;
    border-radius: 10px;
    border: 1px solid var(--border);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    box-shadow: var(--shadow);
}
/* –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–û–ö IPA –ò –°–õ–û–ì–û–í - –ù–ï–ê–ö–¢–ò–í–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï (—Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω) */
.control-buttons .ipa-toggle:not(.active),
.control-buttons .syllables-toggle:not(.active),
.side-panel .ipa-toggle:not(.active),
.side-panel .syllables-toggle:not(.active) {
    background: var(--accent) !important; /* –†–æ–∑–æ–≤—ã–π —Ñ–æ–Ω –∫–æ–≥–¥–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ü–æ–∫–∞–∑–∞—Ç—å..." */
    color: white !important;
    border-color: var(--accent) !important;
}
/* –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–û–ö IPA –ò –°–õ–û–ì–û–í - –ê–ö–¢–ò–í–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï (–±–µ–ª—ã–π —Ñ–æ–Ω) */
.control-buttons .ipa-toggle.active,
.control-buttons .syllables-toggle.active,
.side-panel .ipa-toggle.active,
.side-panel .syllables-toggle.active {
    background: var(--panel) !important; /* –ë–µ–ª—ã–π —Ñ–æ–Ω –∫–æ–≥–¥–∞ –∫–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–°–∫—Ä—ã—Ç—å..." */
    color: var(--text) !important;
    border-color: var(--border) !important;
}
/* ===== –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–ö–ò –°–ê–ú–û–ü–†–û–í–ï–†–ö–ò (–ù–ê–û–ë–û–†–û–¢) ===== */
/* –ù–ï–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –±–µ–ª—ã–π —Ñ–æ–Ω (–∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–æ "üß† –°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞") */
.control-buttons .test-toggle:not(.active),
.side-panel .test-toggle:not(.active) {
    background: var(--panel) !important;
    color: var(--text) !important;
    border-color: var(--border) !important;
}
/* –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - —Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω (–∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–æ "üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã") */
.control-buttons .test-toggle.active,
.side-panel .test-toggle.active {
    background: var(--accent) !important;
    color: white !important;
    border-color: var(--accent) !important;
}
/* ===== –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–ö–ò –°–ö–†–´–¢–ò–Ø –ê–ù–ì–õ–ò–ô–°–ö–û–ì–û (–ù–ê–û–ë–û–†–û–¢) ===== */
/* –ù–ï–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –±–µ–ª—ã–π —Ñ–æ–Ω (–∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–æ "üôà –°–∫—Ä—ã—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π") */
.control-buttons .hide-english-toggle:not(.active),
.side-panel .hide-english-toggle:not(.active) {
    background: var(--panel) !important;
    color: var(--text) !important;
    border-color: var(--border) !important;
}
/* –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - —Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω (–∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–æ "üôà –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π") */
.control-buttons .hide-english-toggle.active,
.side-panel .hide-english-toggle.active {
    background: var(--accent) !important;
    color: white !important;
    border-color: var(--accent) !important;
}
/* ===== –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–ö–ò –ü–ï–ß–ê–¢–ò (–ù–ê–û–ë–û–†–û–¢) ===== */
/* –ù–ï–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –±–µ–ª—ã–π —Ñ–æ–Ω (–∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–æ "‚å®Ô∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–µ—á–∞—Ç–∏") */
.control-buttons .typing-toggle:not(.active),
.side-panel .typing-toggle:not(.active) {
    background: var(--panel) !important;
    color: var(--text) !important;
    border-color: var(--border) !important;
}
/* –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - —Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω (–∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–æ "‚èπÔ∏è –í—ã–∫–ª—é—á–∏—Ç—å –ø–µ—á–∞—Ç—å") */
.control-buttons .typing-toggle.active,
.side-panel .typing-toggle.active {
    background: var(--accent) !important;
    color: white !important;
    border-color: var(--accent) !important;
}
/* ===== –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–ö–ò –≠–ö–°–ü–û–†–¢–ê (–ù–ê–û–ë–û–†–û–¢) ===== */
/* –ù–ï–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –±–µ–ª—ã–π —Ñ–æ–Ω (–∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–æ "üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Anki") */
.control-buttons .export-toggle:not(.active),
.side-panel .export-toggle:not(.active) {
    background: var(--panel) !important;
    color: var(--text) !important;
    border-color: var(--border) !important;
}
/* –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - —Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω (–∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–æ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç") */
.control-buttons .export-toggle.active,
.side-panel .export-toggle.active {
    background: var(--accent) !important;
    color: white !important;
    border-color: var(--accent) !important;
}
/* –°–¢–ò–õ–ò –î–õ–Ø –ê–í–¢–û–ü–†–û–ö–†–£–¢–ö–ò - –ù–ï–ê–ö–¢–ò–í–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï */
.control-buttons .continuous-toggle:not(.continuous-active),
.side-panel .continuous-toggle:not(.continuous-active) {
    background: var(--panel) !important;
    color: var(--text) !important;
    border-color: var(--border) !important;
}
/* –°–¢–ò–õ–ò –î–õ–Ø –ê–í–¢–û–ü–†–û–ö–†–£–¢–ö–ò - –ê–ö–¢–ò–í–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï (–∑–µ–ª–µ–Ω—ã–π —Å –ø—É–ª—å—Å–∞—Ü–∏–µ–π) */
.control-buttons .continuous-toggle.continuous-active,
.side-panel .continuous-toggle.continuous-active {
    background: var(--green) !important;
    color: white !important;
    border-color: var(--green) !important;
    animation: pulse 1.5s infinite;
}
/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(251, 113, 133, 0.7); }
    70% { box-shadow: 0 0 0 8px rgba(251, 113, 133, 0); }
    100% { box-shadow: 0 0 0 0 rgba(251, 113, 133, 0); }
}
/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø—Ä–∏ –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
.highlight-playing {
    background-color: rgba(251, 113, 133, 0.15) !important;
    transition: background-color 0.3s;
    position: relative;
    border-radius: 4px;
}
.highlight-playing::after {
    content: "‚ñ∂";
    position: absolute;
    left: -15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--accent);
    font-size: 12px;
}
/* ===== –°–ï–ö–¶–ò–Ø –ù–ê–°–¢–†–û–ô–ö–ò –û–ó–í–£–ß–ö–ò ===== */
.voice-section {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin: 0 auto 20px;
    max-width: 720px;
    box-shadow: var(--shadow);
}
.voice-section h3 {
    margin: 0 0 12px;
    font-size: 16px;
    color: var(--accent);
    text-align: left;
    padding-left: 8px;
}
.voice-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
}
.voice-row {
    display: flex;
    align-items: center;
    gap: 15px;
    width: 100%;
}
.voice-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-width: 120px;
}
.voice-item label {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 6px;
    font-weight: 500;
}
#voiceSelect {
    width: 100%;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-size: 14px;
    margin-bottom: 8px;
}
.slider-container {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
}
.slider-with-value {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
}
.slider-value {
    min-width: 40px;
    font-size: 13px;
    text-align: right;
    color: var(--text);
    font-weight: 500;
}
input[type="range"] {
    accent-color: var(--accent);
    width: 100%;
    flex: 1;
}
/* ===== –ö–ù–û–ü–ö–ò –°–ü–†–ê–í–ê ===== */
.theme-toggle, .settings-toggle {
    position: fixed;
    top: 18px;
    right: 18px;
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    cursor: pointer;
    background: var(--panel);
    color: var(--text);
    box-shadow: 0 2px 8px rgba(219,39,119,.12);
    z-index: 100;
}
.settings-toggle {
    top: 60px;
}
/* ===== –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ===== */
.side-panel {
    position: fixed;
    top: 102px;
    right: 18px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--shadow);
    display: none;
    z-index: 99;
    width: 320px;
    flex-direction: column;
    gap: 18px;
    opacity: 0;
    transform: translateX(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}
.side-panel.open {
    opacity: 1;
    transform: translateX(0);
}
.side-panel > div {
    width: 100%;
}
.side-panel label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    color: var(--muted);
    font-weight: 500;
    text-align: left;
}
.side-panel select {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 8px;
}
.side-panel select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(219,39,119,0.1);
}
/* –ì–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã –≤–Ω—É—Ç—Ä–∏ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
.side-panel .voice-controls {
    display: flex;
    flex-direction: column;
    gap: 16px;
    width: 100%;
}
.side-panel .voice-row {
    display: flex;
    flex-direction: column;
    gap: 16px;
    width: 100%;
}
.side-panel .voice-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
}
.side-panel .slider-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
}
.side-panel .slider-with-value {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
}
.side-panel .slider-value {
    min-width: 40px;
    font-size: 14px;
    text-align: right;
    color: var(--text);
    font-weight: 500;
}
.side-panel input[type="range"] {
    accent-color: var(--accent);
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: var(--border);
    outline: none;
}
.side-panel input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid var(--card);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
/* ===== –°–ª–æ–≥–æ–≤–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ ===== */
.syllables {
    font-size: 18px;
    margin: 8px 0;
    color: var(--accent);
    font-weight: 600;
    text-align: left;
}
.syllable {
    display: inline-block;
    margin: 0 2px;
}
.syllable.stressed {
    text-decoration: underline;
    font-weight: 700;
}
.example-syllables {
    font-size: 16px;
    margin: 4px 0 8px 0;
    color: var(--accent);
    font-weight: 600;
    text-align: left;
}
/* ===== –ö–ê–†–¢–û–ß–ö–ê ===== */
#container {
    max-width: 720px;
    margin: 0 auto;
}
.card {
    background: var(--card);
    padding: 24px 28px;
    border-radius: 14px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    margin: 0 auto 20px auto;
    text-align: left;
    position: relative;
    transition: all 0.3s ease;
}
/* ===== –ù–û–ú–ï–† + –ò–ö–û–ù–ö–ò –°–ï–†–í–ò–°–û–í ===== */
.card-index {
    position: absolute;
    top: 12px;
    right: 14px;
    font-size: 12px;
    line-height: 1.3;
    padding-bottom: 8px;
}
.card-index a {
    text-decoration: none;
    margin-right: 4px;
    transition: all 0.2s;
    display: inline-block;
    vertical-align: middle;
}
.service-icon {
    width: 20px;
    height: 20px;
    object-fit: contain;
    filter: grayscale(50%);
    opacity: 0.5;
    transition: all 0.2s;
    border-radius: 3px;
    background: var(--bg);
    padding: 2px;
    border: 1px solid var(--border);
}
.service-icon:hover {
    filter: grayscale(0%);
    opacity: 1;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.index-num {
    color: var(--text);
    opacity: 0.15;
    margin-left: 8px;
    font-size: 12px;
    vertical-align: middle;
}
/* ===== –ê–ù–ì–õ–ò–ô–°–ö–û–ï –°–õ–û–í–û –ò –ü–ï–†–ï–í–û–î ===== */
.word-line {
    font-size: 21px;
    margin-bottom: 20px;
    padding-bottom: 12px;
    text-align: left;
    position: relative;
}
.word-en {
    color: var(--accent);
    cursor: pointer;
    font-weight: 700;
    display: block;
}
.word-ru {
    cursor: pointer;
    display: block;
    margin-top: 12px;
}
/* ===== –ü–†–ò–ú–ï–†–´ –° –§–û–ù–û–í–´–ú–ò –ë–õ–û–ö–ê–ú–ò ===== */
.example {
    margin-bottom: 14px;
    background: var(--example-bg);
    border-radius: 10px;
    padding: 14px 16px;
    border: 1px solid var(--border);
}
.en {
    cursor: pointer;
    color: var(--green);
    font-weight: 600;
    margin-bottom: 8px;
    line-height: 1.4;
    font-size: 16px;
}
.ipa {
    font-family: "Lucida Sans Unicode", "Arial Unicode MS", sans-serif;
    color: var(--accent);
    font-size: 18px;
    margin-bottom: 8px;
    padding-left: 8px;
    border-left: 2px solid var(--accent);
    font-style: italic;
    opacity: 0.9;
    line-height: 1.3;
    text-align: left;
}
.ru {
    cursor: pointer;
    color: var(--muted);
    margin-bottom: 0;
    line-height: 1.4;
}
.hide-ru .ru {
    display: none;
}
.hide-ipa .ipa {
    display: none;
}
/* ===== –†–ï–ñ–ò–ú –ü–ï–ß–ê–¢–ò ===== */
.typing-container {
    margin: 15px 0;
    display: none;
}
/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø–µ—á–∞—Ç–∏ –ø—Ä–∏–º–µ—Ä–æ–≤ */
.example-typing-container {
    margin-top: 12px;
    display: none;
}
.typing-input-group {
    position: relative;
    margin-bottom: 15px;
}
.typing-input {
    width: 100%;
    padding: 10px 15px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-size: 16px;
    font-family: 'Courier New', monospace;
    transition: all 0.3s;
}
.typing-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(219,39,119,0.1);
}
.typing-input.correct {
    border-color: var(--green);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
}
.typing-input.incorrect {
    border-color: var(--red);
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
}
.typing-hint {
    font-size: 13px;
    color: var(--muted);
    text-align: center;
    margin-top: 8px;
    font-style: italic;
}
.typing-comparison {
    background: var(--card);
    border-radius: 10px;
    padding: 12px;
    margin: 12px 0;
    border: 1px solid var(--border);
    font-family: 'Courier New', monospace;
    font-size: 15px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    min-height: 60px;
}
.typing-comparison-line {
    margin-bottom: 4px;
    min-height: 24px;
}
.typing-arrow {
    text-align: center;
    color: var(--muted);
    font-size: 14px;
    margin: 2px 0;
    opacity: 0.7;
}
.char {
    padding: 1px 3px;
    border-radius: 2px;
    display: inline-block;
    min-width: 8px;
    text-align: center;
    margin: 0 1px;
    font-size: 14px;
}
.char-correct {
    background-color: rgba(16, 185, 129, 0.2);
    color: var(--green);
    border: 1px solid rgba(16, 185, 129, 0.3);
}
.char-incorrect {
    background-color: rgba(239, 68, 68, 0.2);
    color: var(--red);
    border: 1px solid rgba(239, 68, 68, 0.3);
    text-decoration: line-through;
}
.char-missing {
    opacity: 0.4;
    color: var(--muted);
    border: 1px dashed rgba(156, 163, 175, 0.4);
}
.char-space {
    min-width: 6px;
    background-color: rgba(156, 163, 175, 0.1);
}
.char-space::after {
    content: '¬∑';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.3;
    font-size: 10px;
}
.char-correct.char-space {
    background-color: rgba(16, 185, 129, 0.1);
}
.char-correct.char-space::after {
    color: var(--green);
    opacity: 0.6;
}
.char-incorrect.char-space {
    background-color: rgba(239, 68, 68, 0.1);
}
.char-incorrect.char-space::after {
    color: var(--red);
    opacity: 0.6;
}
/* ===== –†–ï–ñ–ò–ú –°–ö–†–´–¢–ò–Ø –ê–ù–ì–õ–ò–ô–°–ö–û–ì–û ===== */
.hide-english .word-en,
.hide-english .en, /* –°–∫—Ä—ã–≤–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã */
.hide-english .syllables,
.hide-english .ipa,
.hide-english .example-syllables {
    display: none !important;
}
/* ===== –ü–ê–ì–ò–ù–ê–¶–ò–Ø –ò –°–ß–Å–¢–ß–ò–ö –°–õ–û–í ===== */
.pagination-container {
    margin-top: 30px;
}
.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}
.page-btn {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--panel);
    color: var(--text);
    cursor: pointer;
    font-size: 14px;
    min-width: 40px;
}
.page-btn.active {
    background: var(--accent);
    color: white;
}
.word-count {
    font-size: 14px;
    color: var(--muted);
    text-align: center;
}
/* ===== –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø ===== */
@media (max-width: 768px) {
    body {
        padding: 20px 10px 40px;
    }
    h1 {
        font-size: 1.5rem;
        margin: 0 0 8px;
        padding-top: 40px;
    }
    .header-subtitle {
        font-size: 0.85rem;
        margin-bottom: 15px;
    }
    .theme-toggle, .settings-toggle {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 6px 10px;
        font-size: 12px;
    }
    .settings-toggle {
        top: 50px;
    }
    .search-section {
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
    }
    .search-section .stats {
        width: 100%;
        text-align: center;
        font-size: 12px;
        padding: 5px 10px;
    }
    .search-container {
        width: 100%;
        max-width: 100%;
    }
    .filter-bar {
        flex-direction: column;
        gap: 10px;
        margin: 15px auto 10px;
    }
    .filter-container {
        width: 100%;
        max-width: 100%;
    }
    #tagFilter, #themeFilter {
        font-size: 13px;
        padding: 8px 12px;
    }
    .clear-filters {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
    }
    .filter-container label {
        text-align: center;
    }
    .filter-stats {
        text-align: center;
    }
    .voice-row {
        flex-direction: column;
        gap: 10px;
    }
    .voice-item {
        width: 100%;
        max-width: 100%;
    }
    /* –ú–û–ë–ò–õ–¨–ù–ê–Ø –ö–ê–†–¢–û–ß–ö–ê */
    .card {
        padding: 16px;
        margin-bottom: 15px;
        border-radius: 12px;
    }
    .word-line {
        font-size: 18px;
        margin-top: 20px;
        margin-bottom: 16px;
        padding-bottom: 10px;
        text-align: center;
    }
    .syllables, .ipa {
        text-align: center;
    }
    .word-tags {
        justify-content: center;
        margin-bottom: 10px;
        margin-top: 10px;
    }
    .example {
        margin-bottom: 12px;
        padding: 12px 14px;
        border-radius: 8px;
    }
    .en {
        font-size: 15px;
        margin-bottom: 6px;
    }
    .ipa {
        font-size: 16px;
        margin-bottom: 6px;
    }
    .ru {
        font-size: 13px;
    }
    /* –ò–ö–û–ù–ö–ò –°–ï–†–í–ò–°–û–í –ù–ê –ú–û–ë–ò–õ–¨–ù–û–ú */
    .card-index {
        position: relative;
        top: 0;
        right: 0;
        text-align: center;
        margin-bottom: 10px;
        padding-bottom: 0;
    }
    .card-index a {
        margin: 0 3px;
    }
    .service-icon {
        width: 18px;
        height: 18px;
        padding: 1px;
    }
    .index-num {
        display: block;
        margin-top: 5px;
        margin-left: 0;
        font-size: 11px;
    }
    /* –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ –ù–ê –ú–û–ë–ò–õ–¨–ù–û–ú */
    .side-panel {
        top: 70px;
        right: 10px;
        width: calc(100vw - 20px);
        max-width: 300px;
        padding: 16px;
        gap: 14px;
    }
    .side-panel .voice-controls {
        gap: 12px;
    }
    .side-panel .voice-row {
        gap: 12px;
    }
    .side-panel .slider-with-value {
        gap: 8px;
    }
    .side-panel .slider-value {
        font-size: 13px;
        min-width: 35px;
    }
    /* –ú–û–ë–ò–õ–¨–ù–´–ô –†–ï–ñ–ò–ú –ü–ï–ß–ê–¢–ò */
    .typing-input {
        font-size: 15px;
        padding: 8px 12px;
    }
    .typing-comparison {
        font-size: 14px;
        padding: 10px;
    }
    .char {
        padding: 0 2px;
        font-size: 13px;
        min-width: 6px;
    }
}
@media (max-width: 480px) {
    h1 {
        font-size: 1.3rem;
        padding-top: 50px;
    }
    .theme-toggle, .settings-toggle {
        top: 5px;
        right: 5px;
    }
    .settings-toggle {
        top: 45px;
    }
    .card {
        padding: 12px;
    }
    .word-line {
        font-size: 16px;
    }
    .example {
        margin-bottom: 10px;
        padding: 10px 12px;
    }
    .en {
        font-size: 14px;
    }
    .ipa {
        font-size: 14px;
        margin-bottom: 6px;
    }
    .ru {
        font-size: 12px;
    }
    .control-buttons {
        flex-direction: column;
    }
    .test-toggle, .ipa-toggle, .syllables-toggle, .continuous-toggle, .typing-toggle, .hide-english-toggle, .export-toggle {
        width: 100%;
        margin-bottom: 5px;
    }
    .pagination {
        gap: 3px;
    }
    .page-btn {
        padding: 5px 6px;
        font-size: 12px;
        min-width: 32px;
    }
    /* –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ –ù–ê –û–ß–ï–ù–¨ –ú–ê–õ–ï–ù–¨–ö–ò–• –≠–ö–†–ê–ù–ê–• */
    .side-panel {
        padding: 14px;
        gap: 12px;
        max-width: 280px;
    }
    .side-panel label {
        font-size: 13px;
    }
    .side-panel select {
        padding: 8px 10px;
        font-size: 13px;
    }
    .side-panel .test-toggle,
    .side-panel .ipa-toggle,
    .side-panel .syllables-toggle,
    .side-panel .typing-toggle,
    .side-panel .hide-english-toggle,
    .side-panel .continuous-toggle,
    .side-panel .export-toggle {
        padding: 8px 12px;
        font-size: 13px;
    }
    /* –û–ß–ï–ù–¨ –ú–ê–õ–ï–ù–¨–ö–ò–ô –†–ï–ñ–ò–ú –ü–ï–ß–ê–¢–ò */
    .typing-input {
        font-size: 14px;
        padding: 7px 10px;
    }
    .typing-hint {
        font-size: 12px;
        margin-top: 5px;
    }
}
/* –î–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
@media (min-width: 769px) and (max-width: 1024px) {
    .voice-section, .filter-section {
        max-width: 90%;
    }
    #container {
        max-width: 90%;
    }
    .card {
        padding: 20px;
    }
}
/* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ */
.hide-ru .translation {
    display: none;
}
.show-translation-btn {
    display: none;
    padding: 6px 12px;
    margin-top: 8px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
    text-align: center;
}
.hide-ru .show-translation-btn {
    display: block;
}
.hide-ru .translation.shown {
    display: block;
}
.show-translation-btn.hidden {
    display: none;
}
@media (max-width: 768px) {
    .show-translation-btn {
        font-size: 12px;
        padding: 5px 10px;
        margin-top: 6px;
    }
}

/* ===== –°–¢–ò–õ–ò –î–õ–Ø –†–ï–ñ–ò–ú–ê –≠–ö–°–ü–û–†–¢–ê ===== */
/* –ß–µ–∫–±–æ–∫—Å—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
.export-checkbox {
    position: absolute;
    top: 12px;
    left: 14px;
    z-index: 2;
    width: 20px;
    height: 20px;
    cursor: pointer;
}
.export-checkbox:checked {
    accent-color: var(--accent);
}
.export-mode .card {
    padding-left: 44px; /* –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ */
}
.export-mode .export-checkbox {
    display: block;
}
.export-checkbox {
    display: none;
}
/* –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è CSV */
.export-actions {
    display: none;
    justify-content: center;
    gap: 10px;
    margin: 20px auto;
    max-width: 720px;
}
.export-mode .export-actions {
    display: flex;
}
.export-btn {
    padding: 10px 18px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--panel);
    color: var(--text);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    box-shadow: var(--shadow);
}
.export-btn:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}
.export-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.export-btn.disabled:hover {
    background: var(--panel);
    color: var(--text);
    border-color: var(--border);
}
/* –°—á–µ—Ç—á–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
.export-counter {
    display: none;
    font-size: 14px;
    color: var(--muted);
    text-align: center;
    margin: 10px auto;
    max-width: 720px;
}
.export-mode .export-counter {
    display: block;
}
/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —ç–∫—Å–ø–æ—Ä—Ç–µ */
.export-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 20px;
    box-shadow: var(--shadow);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    animation: fadeInOut 3s ease-in-out;
}
.export-notification.success {
    border-color: var(--green);
    background: rgba(157, 23, 77, 0.1);
}
.export-notification.error {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}
</style>
</head>
<body>
<button class="theme-toggle" id="themeBtn" onclick="toggleTheme()">üåô</button>
<button class="settings-toggle" id="settingsBtn" onclick="toggleSettings()">üéôÔ∏è</button>
<h1>üá∫üá∏ American English Vocabulary</h1>
<div class="header-subtitle">–ò–∑—É—á–µ–Ω–∏–µ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–≥–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –ø–æ —Å–ª–æ–≤–∞–º –∏ —Ñ—Ä–∞–∑–∞–º</div>

<!-- ===== –°–ï–ö–¶–ò–Ø –ë–´–°–¢–†–û–ì–û –ü–ï–†–ï–•–û–î–ê ===== -->
<div class="card-jump-section">
<div class="card-jump-container">
<span class="card-jump-icon">üîç</span>
<input
type="number"
id="cardJumpInput"
class="card-jump-input"
placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å–ª–æ–≤–∞"
min="1"
title="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å–ª–æ–≤–∞, –∫ –∫–æ—Ç–æ—Ä–æ–º—É —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–π—Ç–∏"
>
<button
class="card-jump-btn"
onclick="jumpToCard()"
title="–ü–µ—Ä–µ–π—Ç–∏ –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É —Å–ª–æ–≤—É"
>
‚û°Ô∏è –ü–µ—Ä–µ–π—Ç–∏
</button>
</div>
</div>

<!-- ===== –°–ï–ö–¶–ò–Ø –ü–û–ò–°–ö–ê ===== -->
<div class="search-section">
<div class="search-container">
<input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ —Å–ª–æ–≤–∞ –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞...">
</div>
<div class="stats" id="totalStats">–í—Å–µ–≥–æ —Å–ª–æ–≤: 0</div>
</div>

<!-- ===== –°–ï–ö–¶–ò–Ø –§–ò–õ–¨–¢–†–û–í ===== -->
<div class="filter-section">
<h3>üîç –§–∏–ª—å—Ç—Ä—ã</h3>
<div class="filter-bar">
<div class="filter-container" id="tagFilterContainer">
<label>–¢–µ–≥–∏</label>
<select id="tagFilter" multiple size="1">
<option value="">–í—Å–µ —Ç–µ–≥–∏</option>
</select>
<div class="filter-stats" id="tagStats">
–í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–≥–æ–≤: 0
</div>
<div class="selected-tags" id="selectedTags"></div>
</div>
<div class="filter-container" id="themeFilterContainer">
<label>–¢–µ–º—ã</label>
<select id="themeFilter">
<option value="">–í—Å–µ —Ç–µ–º—ã</option>
</select>
<div class="filter-stats" id="themeStats">
–í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–º: 0
</div>
</div>
<button class="clear-filters" id="clearFilters" onclick="clearAllFilters()">
‚úï –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
</button>
</div>
</div>

<!-- ===== –°–ï–ö–¶–ò–Ø –ù–ê–°–¢–†–û–ô–ö–ò –û–ó–í–£–ß–ö–ò ===== -->
<div class="voice-section">
<h3>üîä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∑–≤—É—á–∫–∏</h3>
<div class="voice-controls">
<div class="voice-row">
<div class="voice-item">
<label>–ì–æ–ª–æ—Å:</label>
<select id="voiceSelect"></select>
</div>
<div class="voice-item">
<div class="slider-container">
<label>–°–∫–æ—Ä–æ—Å—Ç—å:</label>
<div class="slider-with-value">
<input id="rateSlider" type="range" min="0.30" max="1.2" step="0.05">
<span class="slider-value" id="rateLabel"></span>
</div>
</div>
</div>
<div class="voice-item">
<div class="slider-container">
<label>–í—ã—Å–æ—Ç–∞ –≥–æ–ª–æ—Å–∞:</label>
<div class="slider-with-value">
<input id="pitchSlider" type="range" min="0.7" max="1.3" step="0.05">
<span class="slider-value" id="pitchLabel"></span>
</div>
</div>
</div>
<div class="voice-item">
<div class="slider-container">
<label>–ó–∞–¥–µ—Ä–∂–∫–∞:</label>
<div class="slider-with-value">
<input id="delaySlider" type="range" min="2" max="10" step="0.5">
<span class="slider-value" id="delayLabel"></span>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- ===== –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===== -->
<div class="control-buttons">
<button class="test-toggle" id="testBtn" onclick="toggleTestMode()">
üß† –°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞
</button>
<button class="ipa-toggle" id="ipaBtn" onclick="toggleIpaMode()">
üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å IPA
</button>
<button class="syllables-toggle" id="syllablesBtn" onclick="toggleSyllablesMode()">
üî§ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–≥–∏
</button>
<button class="typing-toggle" id="typingBtn" onclick="toggleTypingMode()">
‚å®Ô∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–µ—á–∞—Ç–∏
</button>
<button class="hide-english-toggle" id="hideEnglishBtn" onclick="toggleHideEnglishMode()">
üôà –°–∫—Ä—ã—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
</button>
<button class="continuous-toggle" id="continuousBtn" onclick="toggleContinuousMode()">
‚ñ∂Ô∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
</button>
<!-- –ö–ù–û–ü–ö–ê –≠–ö–°–ü–û–†–¢–ê (–æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –º–µ–Ω—é) -->
<button class="export-toggle" id="exportBtn" onclick="toggleExportMode()">
üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Anki
</button>
</div>

<!-- –°–µ–∫—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
<div class="export-actions" id="exportActions">
<button class="export-btn" id="selectAllBtn" onclick="selectAllCards()">
‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
</button>
<button class="export-btn" id="deselectAllBtn" onclick="deselectAllCards()">
‚ùå –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
</button>
<button class="export-btn" id="downloadCsvBtn" onclick="exportToCSV()">
üíæ –°–∫–∞—á–∞—Ç—å CSV
</button>
</div>

<div class="export-counter" id="exportCounter">
–í—ã–±—Ä–∞–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫: <span id="selectedCount">0</span> –∏–∑ <span id="totalCount">0</span>
</div>

<!-- ===== –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ===== -->
<div class="side-panel" id="sidePanel">
<div>
<label>–ì–æ–ª–æ—Å:</label>
<select id="voiceSelectSide"></select>
</div>
<div class="voice-controls">
<div class="voice-row">
<div class="voice-item">
<div class="slider-container">
<label>–°–∫–æ—Ä–æ—Å—Ç—å:</label>
<div class="slider-with-value">
<input id="rateSliderSide" type="range" min="0.30" max="1.2" step="0.05">
<span class="slider-value" id="rateLabelSide"></span>
</div>
</div>
</div>
<div class="voice-item">
<div class="slider-container">
<label>–í—ã—Å–æ—Ç–∞ –≥–æ–ª–æ—Å–∞:</label>
<div class="slider-with-value">
<input id="pitchSliderSide" type="range" min="0.7" max="1.3" step="0.05">
<span class="slider-value" id="pitchLabelSide"></span>
</div>
</div>
</div>
<div class="voice-item">
<div class="slider-container">
<label>–ó–∞–¥–µ—Ä–∂–∫–∞:</label>
<div class="slider-with-value">
<input id="delaySliderSide" type="range" min="2" max="10" step="0.5">
<span class="slider-value" id="delayLabelSide"></span>
</div>
</div>
</div>
</div>
</div>
<div class="control-buttons">
<button class="test-toggle" id="testBtnSide" onclick="toggleTestMode()">
üß† –°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞
</button>
<button class="ipa-toggle" id="ipaBtnSide" onclick="toggleIpaMode()">
üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å IPA
</button>
<button class="syllables-toggle" id="syllablesBtnSide" onclick="toggleSyllablesMode()">
üî§ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–≥–∏
</button>
<button class="typing-toggle" id="typingBtnSide" onclick="toggleTypingMode()">
‚å®Ô∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–µ—á–∞—Ç–∏
</button>
<button class="hide-english-toggle" id="hideEnglishBtnSide" onclick="toggleHideEnglishMode()">
üôà –°–∫—Ä—ã—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
</button>
<button class="continuous-toggle" id="continuousBtnSide" onclick="toggleContinuousMode()">
‚ñ∂Ô∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
</button>
<!-- –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ -->
</div>
</div>

<div id="container"></div>
<div class="pagination-container">
<div class="pagination" id="pagination"></div>
<div class="word-count" id="wordCount"></div>
</div>

<script>
// --- –ù–û–í–´–ô –ö–û–î –î–õ–Ø –≠–ö–°–ü–û–†–¢–ê –í ANKI ---

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
let exportModeActive = false;
let selectedCards = new Set(); // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
async function toggleExportMode() {
    exportModeActive = !exportModeActive;
    const isActive = exportModeActive;
    const mainBtn = document.getElementById("exportBtn");
    const exportActions = document.getElementById("exportActions");
    const exportCounter = document.getElementById("exportCounter");

    if (isActive) {
        mainBtn.classList.add("active");
        mainBtn.textContent = "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç";
        document.body.classList.add("export-mode");
        exportActions.style.display = "flex";
        exportCounter.style.display = "block";
        updateExportCounter();
    } else {
        mainBtn.classList.remove("active");
        mainBtn.textContent = "üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Anki";
        document.body.classList.remove("export-mode");
        exportActions.style.display = "none";
        exportCounter.style.display = "none";
        selectedCards.clear(); // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Ä–µ–∂–∏–º–∞
    }

    renderPage(currentPage); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
function updateExportCounter() {
    const selectedCount = document.getElementById("selectedCount");
    const totalCount = document.getElementById("totalCount");
    const downloadBtn = document.getElementById("downloadCsvBtn");
    const pageData = filteredData.slice(
        (currentPage - 1) * PAGE_SIZE,
        currentPage * PAGE_SIZE
    );

    // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    let pageSelectedCount = 0;
    pageData.forEach(item => {
        if (selectedCards.has(item.word)) {
            pageSelectedCount++;
        }
    });

    selectedCount.textContent = pageSelectedCount;
    totalCount.textContent = pageData.length;

    // –í–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    if (pageSelectedCount > 0) {
        downloadBtn.classList.remove("disabled");
    } else {
        downloadBtn.classList.add("disabled");
    }
}

// –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞/–æ—Ç–º–µ–Ω—ã –≤—ã–±–æ—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
function toggleCardSelection(word, checkbox) {
    if (checkbox.checked) {
        selectedCards.add(word);
    } else {
        selectedCards.delete(word);
    }
    updateExportCounter();
}

// –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
function selectAllCards() {
    const pageData = filteredData.slice(
        (currentPage - 1) * PAGE_SIZE,
        currentPage * PAGE_SIZE
    );
    pageData.forEach(item => {
        selectedCards.add(item.word);
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
    document.querySelectorAll('.export-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });

    updateExportCounter();
}

// –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
function deselectAllCards() {
    const pageData = filteredData.slice(
        (currentPage - 1) * PAGE_SIZE,
        currentPage * PAGE_SIZE
    );
    pageData.forEach(item => {
        selectedCards.delete(item.word);
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
    document.querySelectorAll('.export-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });

    updateExportCounter();
}

// –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ CSV —Å –Ω–æ–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
function exportToCSV() {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    const selectedData = allData.filter(item => selectedCards.has(item.word));

    if (selectedData.length === 0) {
        showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
        return;
    }

    // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç CSV –¥–ª—è Anki: en, ru, Word, Translation
    let csvContent = 'en;ru;Word;Translation\n';

    selectedData.forEach(item => {
        // –û—á–∏—â–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
        const cleanWord = item.word.replace(/"/g, '""').replace(/;/g, ',');
        const cleanTranslation = item.translation.replace(/"/g, '""').replace(/;/g, ',');

        // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ —Å–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É
        item.examples.forEach(ex => {
            const cleanEn = ex.en.replace(/"/g, '""').replace(/;/g, ',');
            const cleanRu = ex.ru.replace(/"/g, '""').replace(/;/g, ',');

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ CSV –≤ –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
            csvContent += `"${cleanEn}";"${cleanRu}";"${cleanWord}";"${cleanTranslation}"\n`;
        });
    });

    // –°–æ–∑–¥–∞–µ–º Blob –∏ —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `anki_export_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ (–ø—Ä–∏–º–µ—Ä–æ–≤)
    const totalExamples = selectedData.reduce((sum, item) => sum + item.examples.length, 0);
    showNotification(`‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${selectedData.length} –∫–∞—Ä—Ç–æ—á–µ–∫ (${totalExamples} –ø—Ä–∏–º–µ—Ä–æ–≤) –≤ CSV`, 'success');
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `export-notification ${type}`;
    notification.innerHTML = message;

    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    document.querySelectorAll('.export-notification').forEach(el => el.remove());

    document.body.appendChild(notification);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// --- –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –ö–û–î –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---

/*
Schema v3:
- progress store (learning state)
- simplified spaced repetition
- local-only persistence
- no accounts, no sync
*/
// --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è schema ---
const CURRENT_SCHEMA_VERSION = 3;
// --- Pipeline –º–∏–≥—Ä–∞—Ü–∏–π (—Ä–∞—Å—à–∏—Ä—è–µ–º—ã–π –æ–±—ä–µ–∫—Ç) ---
// –ö–ª—é—á ‚Äî –∏—Å—Ö–æ–¥–Ω–∞—è –≤–µ—Ä—Å–∏—è (from), –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî async —Ñ—É–Ω–∫—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ to next.
const migrations = {
    1: async function migrateV1toV2() {
        /**
         * migrateV1toV2
         * - –û–±–Ω–æ–≤–ª—è–µ—Ç schema_version —Å '1' (—Å—Ç—Ä–æ–∫–∞) –Ω–∞ 2 (—á–∏—Å–ª–æ); –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–∞–Ω–Ω—ã—Ö settings.
         * - –ü–æ—á–µ–º—É: –í–≤–µ–¥–µ–Ω–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π –¥–ª—è consistency –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –±—É–¥—É—â–∏–º —Å—Ö–µ–º–∞–º (v3+).
         * - –ö–∞–∫–∏–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è: –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª—é—á–∏/–∑–Ω–∞—á–µ–Ω–∏—è –≤ settings –∏ meta –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏; –º–∏–≥—Ä–∞—Ü–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞ (–µ—Å–ª–∏ version —É–∂–µ 2 ‚Äî no-op).
         */
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['meta'], 'readwrite');
            const metaStore = transaction.objectStore('meta');
            const getRequest = metaStore.get('schema_version');
            getRequest.onsuccess = () => {
                const current = getRequest.result ? getRequest.result.value : null;
                // –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –ï—Å–ª–∏ —É–∂–µ 2 ‚Äî resolve –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
                if (current === 2 || parseInt(current) >= 2) {
                    resolve();
                    return;
                }
                // –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ transaction.
                metaStore.put({ key: 'schema_version', value: 2 });
            };
            getRequest.onerror = reject;
            transaction.oncomplete = resolve;
            transaction.onerror = (err) => {
                console.error('–û—à–∏–±–∫–∞ –≤ migrateV1toV2:', err);
                reject(err);
            };
        });
    },
    2: async function migrateV2toV3() {
        /**
         * migrateV2toV3
         * - –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ö–µ–º—É –¥–ª—è progress/SRS
         * - –ù–µ –∏–∑–º–µ–Ω—è–µ—Ç user data
         * - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞
         */
        return Promise.resolve();
    }
    // –î–ª—è v4: –¥–æ–±–∞–≤–∏—Ç—å 3: migrateV3toV4, –∏ —Ç.–¥.
};
// --- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π (—É–ª—É—á—à–µ–Ω–∏–µ: –≤—Å–µ –∫–ª—é—á–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è) ---
const STORAGE_KEYS = {
    THEME: 'theme',
    SHOW_IPA: 'show_ipa',
    SHOW_SYLLABLES: 'show_syllables',
    TTS_VOICE: 'tts_voice',
    TTS_RATE: 'tts_rate',
    TTS_PITCH: 'tts_pitch',
    CONTINUOUS_MODE: 'continuous_mode',
    CONTINUOUS_DELAY: 'continuous_delay',
    TYPING_MODE: 'typing_mode',
    HIDE_ENGLISH: 'hide_english'
};
// --- Storage Abstraction Layer ---
// INVARIANT: –ü–æ—Å–ª–µ migration_done === true, IndexedDB —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã.
// INVARIANT: localStorage –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –∫–∞–∫ legacy fallback –ø—Ä–∏ runtime –æ—à–∏–±–∫–∞—Ö IDB, –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
// –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–ª–µ–Ω storage.mode –¥–ª—è —è–≤–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ ("IDB" –∏–ª–∏ "LS").
// –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–ª–µ–Ω storage.ready –¥–ª—è explicit ready state, —Å warning –ø—Ä–∏ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö.
// –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–ª–µ–Ω storage.degraded –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è runtime –æ—à–∏–±–æ–∫ IDB.
// –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–ª–µ–Ω storage.lastError –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—à–∏–±–∫–∏.
// –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: –£–¥–∞–ª–µ–Ω storage.has(), —Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ fallback –¥–ª—è –Ω–µ–≥–æ –Ω–µ –Ω—É–∂–µ–Ω (—Å—Ç—Ä–æ–≥–æ IDB –≤–∞—Ä–∏–∞–Ω—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è).
// –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –∫–ª—é—á–∏ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ –ø–µ—á–∞—Ç–∏ –∏ —Å–∫—Ä—ã—Ç–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
// degraded === true means:
// - IDB runtime error occurred
// - fallback to localStorage was used
// - no automatic recovery is attempted
// RULE:
// storage.init() MUST complete before any UI render or storage access
const KNOWN_KEYS = Object.values(STORAGE_KEYS);
const storage = {
    db: null, // IDB instance
    mode: null, // "IDB" –∏–ª–∏ "LS" - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤.
    ready: false, // Explicit ready state –ø–æ—Å–ª–µ init/migration/schema.
    degraded: false,
    lastError: null,
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è + –º–∏–≥—Ä–∞—Ü–∏—è (–∫—Ä–∏—Ç–∏—á–Ω–æ: –≤—ã–∑—ã–≤–∞—Ç—å –¥–æ –ª—é–±–æ–≥–æ —á—Ç–µ–Ω–∏—è/—Ä–µ–Ω–¥–µ—Ä–∞).
    // –£–ª—É—á—à–µ–Ω–∏–µ: –ú–∏–≥—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å, —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º 'meta' store.
    // –ü—Ä–æ–≤–µ—Ä–∫–∞/—É—Å—Ç–∞–Ω–æ–≤–∫–∞ schema_version –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –±—É–¥—É—â–∏–º upgrades.
    async init() {
        return new Promise((resolve, reject) => {
            // NOTE:
            // IndexedDB version –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É objectStore'–æ–≤
            // schema_version ‚Äî –∑–∞ –ª–æ–≥–∏–∫—É –∏ –¥–∞–Ω–Ω—ã–µ
            const request = indexedDB.open('appStorage', 2); // Versioned DB.
            // –°–æ–∑–¥–∞–Ω–∏–µ stores, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (—É–ª—É—á—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª–µ–Ω 'meta' store).
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings', { keyPath: 'key' });
                }
                if (!db.objectStoreNames.contains('meta')) {
                    db.createObjectStore('meta', { keyPath: 'key' });
                }
                if (!db.objectStoreNames.contains('progress')) {
                    db.createObjectStore('progress', { keyPath: 'wordId' });
                }
            };
            request.onsuccess = async (event) => {
                this.db = event.target.result;
                try {
                    const migrated = await this.getMeta('migration_done');
                    if (migrated !== 'true') {
                        // –ú–∏–≥—Ä–∞—Ü–∏—è: –ê—Ç–æ–º–∞—Ä–Ω–∞—è –≤ transaction –¥–ª—è 'settings' –∏ 'meta'.
                        const transaction = this.db.transaction(['settings', 'meta'], 'readwrite');
                        const settingsStore = transaction.objectStore('settings');
                        const metaStore = transaction.objectStore('meta');
                        // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –≤—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ LS –≤ IDB (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è).
                        KNOWN_KEYS.forEach(key => {
                            const value = localStorage.getItem(key);
                            if (value !== null) { // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ/–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ.
                                settingsStore.put({ key, value });
                            }
                        });
                        // Set flag –∏ schema_version –≤ 'meta' (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ).
                        metaStore.put({ key: 'migration_done', value: 'true' });
                        metaStore.put({ key: 'schema_version', value: 2 });
                        transaction.oncomplete = () => {
                            console.log('–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.');
                        };
                        transaction.onerror = (err) => {
                            console.warn('–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ (init error), fallback –Ω–∞ LS:', err);
                            this.mode = "LS";
                            this.degraded = true;
                            this.lastError = err;
                            this.ready = true;
                            resolve(); // –ù–µ –ª–æ–º–∞–µ–º app.
                            return;
                        };
                    } else {
                        console.log('–ú–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.');
                    }
                    // –ù–æ–≤—ã–π –±–ª–æ–∫: Schema migration pipeline (–ø–æ—Å–ª–µ legacy migration).
                    let currentVersion = parseInt(await this.getMeta('schema_version')) || 1;
                    while (currentVersion < CURRENT_SCHEMA_VERSION) {
                        const nextVersion = currentVersion + 1;
                        const migrationFn = migrations[currentVersion];
                        if (!migrationFn) {
                            throw new Error(`–ù–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –≤–µ—Ä—Å–∏–∏ ${currentVersion}`);
                        }
                        try {
                            // Bind this (storage) –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ db –≤ –º–∏–≥—Ä–∞—Ü–∏–∏.
                            await migrationFn.call(this);
                            await this.setMeta('schema_version', nextVersion);
                            currentVersion = nextVersion;
                        } catch (err) {
                            console.error(`–ú–∏–≥—Ä–∞—Ü–∏—è v${currentVersion}toV${nextVersion} –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å:`, err);
                            // NOTE: Rollback –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö (single-transaction) –º–∏–≥—Ä–∞—Ü–∏–π
                            // Fallback –Ω–∞ LS –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
                            this.mode = "LS";
                            this.degraded = true;
                            this.lastError = err;
                            break; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º pipeline, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ continue —Å v1.
                        }
                    }
                    this.mode = "IDB";
                    this.ready = true;
                    resolve();
                } catch (err) {
                    console.warn('–û—à–∏–±–∫–∞ init (migration/schema), fallback –Ω–∞ LS:', err);
                    this.db = null; // Mark as failed.
                    this.mode = "LS";
                    this.degraded = true;
                    this.lastError = err;
                    this.ready = true;
                    resolve(); // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI.
                }
            };
            request.onerror = (err) => {
                console.warn('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è IDB (init error), –ø–æ–ª–Ω—ã–π fallback –Ω–∞ LS:', err);
                this.db = null; // Mark as failed.
                this.mode = "LS";
                this.degraded = true;
                this.lastError = err;
                this.ready = true;
                resolve(); // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI.
            };
        });
    },
    // –£–ª—É—á—à–µ–Ω–∏–µ: –û—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è 'meta' (getMeta/setMeta) –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è concerns.
    async getMeta(key) {
        if (!this.db) return null; // Fallback: meta only in IDB, if failed - no meta.
        return new Promise((resolve) => {
            try {
                const transaction = this.db.transaction(['meta'], 'readonly');
                const store = transaction.objectStore('meta');
                const request = store.get(key);
                request.onsuccess = () => {
                    resolve(request.result ? request.result.value : null);
                };
                request.onerror = (e) => {
                    console.warn(`–û—à–∏–±–∫–∞ getMeta(${key}) –∏–∑ IDB (runtime error).`);
                    resolve(null);
                };
            } catch (err) {
                console.warn(`–û—à–∏–±–∫–∞ getMeta(${key}) (runtime error):`, err);
                this.degraded = true;
                this.lastError = err;
                resolve(null);
            }
        });
    },
    async setMeta(key, value) {
        if (!this.db) return; // No fallback for meta.
        return new Promise((resolve) => {
            try {
                const transaction = this.db.transaction(['meta'], 'readwrite');
                const store = transaction.objectStore('meta');
                store.put({ key, value });
                transaction.oncomplete = () => resolve();
                transaction.onerror = (e) => {
                    console.warn(`–û—à–∏–±–∫–∞ setMeta(${key}) –≤ IDB (runtime error).`);
                    this.degraded = true;
                    this.lastError = e?.target?.error || e;
                    resolve();
                };
            } catch (err) {
                console.warn(`–û—à–∏–±–∫–∞ setMeta(${key}) (runtime error):`, err);
                this.degraded = true;
                this.lastError = err;
                resolve();
            }
        });
    },
    // Get: –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ ready/mode, –∑–∞—Ç–µ–º IDB –∏–ª–∏ LS.
    // INVARIANT: –ï—Å–ª–∏ mode === "IDB", localStorage –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ runtime –æ—à–∏–±–∫–µ IDB (read-only legacy).
    // –ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ IDB -> LS.
    async get(key) {
        if (!this.ready) {
            console.warn(`Storage get(${key}) called before ready.`);
        }
        if (this.mode === "LS" || !this.db) return localStorage.getItem(key);
        return new Promise((resolve) => {
            try {
                const transaction = this.db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.get(key);
                request.onsuccess = () => {
                    const value = request.result ? request.result.value : null;
                    resolve(value !== null ? value : localStorage.getItem(key));
                };
                request.onerror = (e) => {
                    console.warn(`–û—à–∏–±–∫–∞ get(${key}) –∏–∑ IDB (runtime error), fallback –Ω–∞ LS.`);
                    this.degraded = true;
                    this.lastError = e?.target?.error || e;
                    resolve(localStorage.getItem(key));
                };
            } catch (err) {
                console.warn(`–û—à–∏–±–∫–∞ get(${key}) (runtime error), fallback –Ω–∞ LS:`, err);
                this.degraded = true;
                this.lastError = err;
                resolve(localStorage.getItem(key));
            }
        });
    },
    // Set: –ü—Ä–æ–≤–µ—Ä–∫–∞ ready/mode, –∑–∞—Ç–µ–º IDB –∏–ª–∏ LS.
    // INVARIANT: –ü–æ—Å–ª–µ migration_done === true, –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–¥—É—Ç —Ç–æ–ª—å–∫–æ –≤ IDB (–µ—Å–ª–∏ mode="IDB"), fallback –Ω–∞ LS —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ.
    async set(key, value) {
        if (!this.ready) {
            console.warn(`Storage set(${key}) called before ready.`);
        }
        if (this.mode === "LS" || !this.db) {
            localStorage.setItem(key, value);
            return;
        }
        return new Promise((resolve) => {
            try {
                const transaction = this.db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                store.put({ key, value });
                transaction.oncomplete = () => resolve();
                transaction.onerror = (e) => {
                    console.warn(`–û—à–∏–±–∫–∞ set(${key}) –≤ IDB (runtime error), fallback –Ω–∞ LS.`);
                    this.degraded = true;
                    this.lastError = e?.target?.error || e;
                    localStorage.setItem(key, value);
                    resolve();
                };
            } catch (err) {
                console.warn(`–û—à–∏–±–∫–∞ set(${key}) (runtime error), fallback –Ω–∞ LS:`, err);
                this.degraded = true;
                this.lastError = err;
                localStorage.setItem(key, value);
                resolve();
            }
        });
    },
    // Remove: –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ set, –Ω–æ delete.
    async remove(key) {
        if (!this.ready) {
            console.warn(`Storage remove(${key}) called before ready.`);
        }
        if (this.mode === "LS" || !this.db) {
            localStorage.removeItem(key);
            return;
        }
        return new Promise((resolve) => {
            try {
                const transaction = this.db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                store.delete(key);
                transaction.oncomplete = () => resolve();
                transaction.onerror = (e) => {
                    console.warn(`–û—à–∏–±–∫–∞ remove(${key}) –≤ IDB (runtime error), fallback –Ω–∞ LS.`);
                    this.degraded = true;
                    this.lastError = e?.target?.error || e;
                    localStorage.removeItem(key);
                    resolve();
                };
            } catch (err) {
                console.warn(`–û—à–∏–±–∫–∞ remove(${key}) (runtime error), fallback –Ω–∞ LS:`, err);
                this.degraded = true;
                this.lastError = err;
                localStorage.removeItem(key);
                resolve();
            }
        });
    },
    async getProgress(wordId) {
        if (!this.ready) throw new Error('Storage not ready');
        if (this.mode !== "IDB" || !this.db) return null; // No LS fallback for progress
        return new Promise((resolve, reject) => {
            try {
                const tx = this.db.transaction('progress', 'readonly');
                const store = tx.objectStore('progress');
                const req = store.get(wordId);
                req.onsuccess = () => resolve(req.result || null);
                req.onerror = (e) => {
                    this.degraded = true;
                    this.lastError = e?.target?.error || e;
                    reject(req.error);
                };
            } catch (err) {
                this.degraded = true;
                this.lastError = err;
                reject(err);
            }
        });
    },
    async setProgress(wordId, progress) {
        if (!this.ready) throw new Error('Storage not ready');
        if (this.mode !== "IDB" || !this.db) return; // No LS
        return new Promise((resolve, reject) => {
            try {
                const tx = this.db.transaction('progress', 'readwrite');
                const store = tx.objectStore('progress');
                store.put({wordId, ...progress});
                tx.oncomplete = () => resolve();
                tx.onerror = (e) => {
                    this.degraded = true;
                    this.lastError = e?.target?.error || tx.error;
                    reject(tx.error);
                };
            } catch (err) {
                this.degraded = true;
                this.lastError = err;
                reject(err);
            }
        });
    },
    async deleteProgress(wordId) {
        if (!this.ready) throw new Error('Storage not ready');
        if (this.mode !== "IDB" || !this.db) return;
        return new Promise((resolve, reject) => {
            try {
                const tx = this.db.transaction('progress', 'readwrite');
                const store = tx.objectStore('progress');
                store.delete(wordId);
                tx.oncomplete = () => resolve();
                tx.onerror = (e) => {
                    this.degraded = true;
                    this.lastError = e?.target?.error || tx.error;
                    reject(tx.error);
                };
            } catch (err) {
                this.degraded = true;
                this.lastError = err;
                reject(err);
            }
        });
    },
    async getAllProgress() {
        if (!this.ready) throw new Error('Storage not ready');
        if (this.mode !== "IDB" || !this.db) return [];
        return new Promise((resolve, reject) => {
            try {
                const tx = this.db.transaction('progress', 'readonly');
                const store = tx.objectStore('progress');
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = (e) => {
                    this.degraded = true;
                    this.lastError = e?.target?.error || e;
                    reject(req.error);
                };
            } catch (err) {
                this.degraded = true;
                this.lastError = err;
                reject(err);
            }
        });
    },
    async exportAll() {
        if (!this.ready) throw new Error('Storage not ready');
        const settingsPromises = KNOWN_KEYS.map(async key => [key, await this.get(key)]);
        const settings = Object.fromEntries(await Promise.all(settingsPromises));
        const progress = await this.getAllProgress();
        const progressObj = progress.reduce((acc, p) => {
            acc[p.wordId] = p;
            return acc;
        }, {});
        return {
            schema: CURRENT_SCHEMA_VERSION,
            exportedAt: Date.now(),
            data: {
                settings,
                progress: progressObj
            }
        };
    },
    async importAll(json) {
        if (!this.ready) throw new Error('Storage not ready');
        if (json.schema !== CURRENT_SCHEMA_VERSION) throw new Error('Invalid schema version');
        return new Promise((resolve, reject) => {
            try {
                const tx = this.db.transaction(['settings', 'progress'], 'readwrite');
                const sStore = tx.objectStore('settings');
                const pStore = tx.objectStore('progress');
                sStore.clear();
                pStore.clear();
                Object.entries(json.data.settings).forEach(([key, value]) => {
                    if (KNOWN_KEYS.includes(key)) {
                        sStore.put({ key, value });
                    }
                });
                Object.values(json.data.progress).forEach(p => pStore.put(p));
                tx.oncomplete = async () => {
                    const allProgress = await this.getAllProgress();
                    progressMap = new Map(allProgress.map(p => [p.wordId, p]));
                    resolve();
                };
                tx.onerror = (e) => reject(tx.error);
            } catch (err) {
                reject(err);
            }
        });
    }
};
// UI Progress Cache
// -----------------
// progressMap ‚Äî —ç—Ç–æ in-memory UI-–∫—ç—à —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±—É—á–µ–Ω–∏—è.
// –û–Ω:
// - –ù–ï —è–≤–ª—è–µ—Ç—Å—è source of truth
// - –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ storage
// - –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ init()
// - –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –≤ UI-—Å–ª–æ–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π storage
//
// storage-layer –ù–ï –∑–Ω–∞–µ—Ç –æ progressMap.
let progressMap = new Map();
const SRS_INTERVALS = [0, 1, 3, 7, 14, 30, 60];
function updateProgress(progress, remembered) {
    if (remembered) {
        progress.level = Math.min(progress.level + 1, SRS_INTERVALS.length - 1);
    } else {
        progress.level = 0;
    }
    const days = SRS_INTERVALS[progress.level];
    progress.lastReview = Date.now();
    progress.nextReview = Date.now() + days * 86400000;
}
const PAGE_SIZE = 100;
let allData = [];
let filteredData = [];
let currentPage = 1;
let currentSearch = '';
let showIpa = false;
let showSyllables = false;
let isAndroid = false;
let isMobileView = false;
let currentTags = [];
let currentTheme = '';
let allTags = new Set();
let allThemes = new Set();
let tagCounts = {};
let themeCounts = {};
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∏
let continuousMode = false;
let continuousPlaybackActive = false;
let continuousElements = [];
let currentContinuousIndex = -1;
let continuousTimeout = null;
let continuousDelay = 3; // –ó–Ω–∞—á–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ –ø–µ—á–∞—Ç–∏ –∏ —Å–∫—Ä—ã—Ç–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
let typingModeActive = false;
let hideEnglishMode = false;

function detectPlatform() {
    const userAgent = navigator.userAgent.toLowerCase();
    isAndroid = /android/.test(userAgent);
    isMobileView = window.innerWidth <= 768;
}
window.addEventListener('resize', handleResize);
function handleResize() {
    const wasMobile = isMobileView;
    isMobileView = window.innerWidth <= 768;
    if (wasMobile !== isMobileView) {
        renderPage(currentPage);
    }
}
function updateStats() {
    const total = allData.length;
    const filtered = filteredData.length;
    const start = (currentPage - 1) * PAGE_SIZE + 1;
    const end = Math.min(start + PAGE_SIZE - 1, filtered);
    document.getElementById('totalStats').textContent =
        `–í—Å–µ–≥–æ —Å–ª–æ–≤: ${total} (–Ω–∞–π–¥–µ–Ω–æ: ${filtered})`;
    document.getElementById('wordCount').textContent =
        filtered > 0 ? `–ü–æ–∫–∞–∑–∞–Ω—ã —Å–ª–æ–≤–∞ ${start}-${end} –∏–∑ ${filtered}` : '–°–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
}
function extractTagsAndThemes() {
    allTags.clear();
    allThemes.clear();
    tagCounts = {};
    themeCounts = {};
    allData.forEach(item => {
        if (item.tags) {
            item.tags.forEach(tag => {
                allTags.add(tag);
                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
            });
        }
        if (item.theme) {
            allThemes.add(item.theme);
            themeCounts[item.theme] = (themeCounts[item.theme] || 0) + 1;
        }
    });
    document.getElementById('tagStats').textContent =
        `–í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–≥–æ–≤: ${allTags.size}`;
    document.getElementById('themeStats').textContent =
        `–í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–º: ${allThemes.size}`;
    populateFilterDropdowns();
}
function populateFilterDropdowns() {
    const tagFilter = document.getElementById('tagFilter');
    const themeFilter = document.getElementById('themeFilter');
    const sortedTags = Array.from(allTags).sort();
    tagFilter.innerHTML = '<option value="">–í—Å–µ —Ç–µ–≥–∏</option>';
    sortedTags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        const count = tagCounts[tag] || 0;
        option.textContent = `${tag} (${count})`;
        option.title = `${tag} ‚Äî ${count} —Å–ª–æ–≤`;
        tagFilter.appendChild(option);
    });
    tagFilter.setAttribute('multiple', 'multiple');
    const sortedThemes = Array.from(allThemes).sort();
    themeFilter.innerHTML = '<option value="">–í—Å–µ —Ç–µ–º—ã</option>';
    sortedThemes.forEach(theme => {
        const option = document.createElement('option');
        option.value = theme;
        const count = themeCounts[theme] || 0;
        const displayName = theme.length > 35 ? theme.substring(0, 35) + '...' : theme;
        option.textContent = `${displayName} (${count})`;
        option.title = `${theme} ‚Äî ${count} —Å–ª–æ–≤`;
        themeFilter.appendChild(option);
    });
}
function updateSelectedTagsDisplay() {
    const container = document.getElementById('selectedTags');
    container.innerHTML = '';
    const filterTitle = document.querySelector('#tagFilterContainer label');
    if (filterTitle) {
        filterTitle.textContent = `–¢–µ–≥–∏ (–≤—ã–±—Ä–∞–Ω–æ: ${currentTags.length})`;
    }
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    updateActiveFilterState();
    currentTags.forEach(tag => {
        const count = tagCounts[tag] || 0;
        const badge = document.createElement('div');
        badge.className = 'tag-badge';
        badge.innerHTML = `${tag} <span class="tag-count">${count}</span> <span class="remove-tag" onclick="removeTag('${tag}')">√ó</span>`;
        container.appendChild(badge);
    });
}
function removeTag(tagToRemove) {
    currentTags = currentTags.filter(tag => tag !== tagToRemove);
    const tagFilter = document.getElementById('tagFilter');
    Array.from(tagFilter.options).forEach(option => {
        if (option.value === tagToRemove) {
            option.selected = false;
        }
    });
    updateSelectedTagsDisplay();
    applyFilters();
}
function clearAllFilters() {
    currentTags = [];
    currentTheme = '';
    const tagFilter = document.getElementById('tagFilter');
    const themeFilter = document.getElementById('themeFilter');
    Array.from(tagFilter.options).forEach(option => {
        option.selected = false;
    });
    tagFilter.selectedIndex = 0;
    themeFilter.selectedIndex = 0;
    const filterTitle = document.querySelector('#tagFilterContainer label');
    if (filterTitle) {
        filterTitle.textContent = '–¢–µ–≥–∏';
    }
    updateSelectedTagsDisplay();
    applyFilters();
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    updateActiveFilterState();
}
function updateActiveFilterState() {
    const tagContainer = document.getElementById('tagFilterContainer');
    const themeContainer = document.getElementById('themeFilterContainer');
    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ —Å–æ –≤—Å–µ—Ö
    tagContainer.classList.remove('active-filter');
    themeContainer.classList.remove('active-filter');
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞, –µ—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω–µ–Ω
    if (currentTags.length > 0) {
        tagContainer.classList.add('active-filter');
    }
    if (currentTheme) {
        themeContainer.classList.add('active-filter');
    }
}
async function applyFilters() {
    filteredData = allData.filter(item => {
        if (currentSearch) {
            const searchLower = currentSearch.toLowerCase();
            const inWord = item.word.toLowerCase().includes(searchLower);
            const inTranslation = item.translation.toLowerCase().includes(searchLower);
            const inExamples = item.examples.some(ex =>
                ex.en.toLowerCase().includes(searchLower) ||
                ex.ru.toLowerCase().includes(searchLower)
            );
            if (!inWord && !inTranslation && !inExamples) return false;
        }
        if (currentTags.length > 0) {
            if (!item.tags || !item.tags.length) return false;
            const hasAllTags = currentTags.every(tag => item.tags.includes(tag));
            if (!hasAllTags) return false;
        }
        if (currentTheme) {
            if (!item.theme || item.theme !== currentTheme) return false;
        }
        return true;
    });
    updateStats();
    renderPage(currentPage);
    buildPagination();
    updateActiveFilterState(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
}
function initFilters() {
    const tagFilter = document.getElementById('tagFilter');
    const themeFilter = document.getElementById('themeFilter');
    tagFilter.addEventListener('change', function() {
        currentTags = Array.from(this.selectedOptions)
            .map(opt => opt.value)
            .filter(val => val !== "");
        updateSelectedTagsDisplay();
        applyFilters();
    });
    themeFilter.addEventListener('change', function() {
        currentTheme = this.value;
        updateActiveFilterState(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        applyFilters();
    });
}
async function toggleIpaMode() {  // –£–ª—É—á—à–µ–Ω–∏–µ: –°–¥–µ–ª–∞–Ω–æ async –¥–ª—è await storage.set.
    showIpa = !showIpa;
    document.body.classList.toggle("hide-ipa", !showIpa);
    const txt = showIpa
        ? "üôà –°–∫—Ä—ã—Ç—å IPA"
        : "üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å IPA";
    document.getElementById("ipaBtn").textContent = txt;
    document.getElementById("ipaBtnSide").textContent = txt;
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
    const ipaBtn = document.getElementById("ipaBtn");
    const ipaBtnSide = document.getElementById("ipaBtnSide");
    if (showIpa) {
        ipaBtn.classList.add("active");
        ipaBtnSide.classList.add("active");
    } else {
        ipaBtn.classList.remove("active");
        ipaBtnSide.classList.remove("active");
    }
    await storage.set(STORAGE_KEYS.SHOW_IPA, showIpa);
}
async function toggleSyllablesMode() {  // –£–ª—É—á—à–µ–Ω–∏–µ: –°–¥–µ–ª–∞–Ω–æ async –¥–ª—è await storage.set.
    showSyllables = !showSyllables;
    document.body.classList.toggle("show-syllables", showSyllables);
    const txt = showSyllables
        ? "üî§ –°–∫—Ä—ã—Ç—å —Å–ª–æ–≥–∏"
        : "üî§ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–≥–∏";
    document.getElementById("syllablesBtn").textContent = txt;
    document.getElementById("syllablesBtnSide").textContent = txt;
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
    const syllablesBtn = document.getElementById("syllablesBtn");
    const syllablesBtnSide = document.getElementById("syllablesBtnSide");
    if (showSyllables) {
        syllablesBtn.classList.add("active");
        syllablesBtnSide.classList.add("active");
    } else {
        syllablesBtn.classList.remove("active");
        syllablesBtnSide.classList.remove("active");
    }
    await storage.set(STORAGE_KEYS.SHOW_SYLLABLES, showSyllables);
    renderPage(currentPage);
}
// ===== –§–£–ù–ö–¶–ò–ò –†–ï–ñ–ò–ú–ê –ü–ï–ß–ê–¢–ò =====
// –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ —Å—Ç–∏–ª–µ Anki (—Å–∏–º–≤–æ–ª –∑–∞ —Å–∏–º–≤–æ–ª–æ–º)
function compareStringsAnkiStyle(user, correct) {
    const userChars = user.split('');
    const correctChars = correct.split('');
    let userLine = '<div class="typing-comparison-line">';
    let correctLine = '<div class="typing-comparison-line">';
    const maxLength = Math.max(userChars.length, correctChars.length);
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
    for (let i = 0; i < maxLength; i++) {
        const userChar = userChars[i] || '';
        const correctChar = correctChars[i] || '';
        const isSpace = userChar === ' ' || correctChar === ' ';
        if (userChar && correctChar && userChar.toLowerCase() === correctChar.toLowerCase()) {
            userLine += `<span class="char char-correct${isSpace ? ' char-space' : ''}">${userChar === ' ' ? ' ' : userChar}</span>`;
        } else if (userChar) {
            userLine += `<span class="char char-incorrect${isSpace ? ' char-space' : ''}">${userChar === ' ' ? ' ' : userChar}</span>`;
        } else if (correctChar) {
            userLine += `<span class="char char-missing${correctChar === ' ' ? ' char-space' : ''}">${correctChar === ' ' ? ' ' : correctChar}</span>`;
        }
    }
    userLine += '</div>';
    // –°—Ç—Ä–µ–ª–∫–∞
    const arrow = '<div class="typing-arrow">‚Üì</div>';
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    for (let i = 0; i < maxLength; i++) {
        const correctChar = correctChars[i] || '';
        const isSpace = correctChar === ' ';
        if (i < userChars.length && userChars[i].toLowerCase() === correctChar.toLowerCase()) {
            correctLine += `<span class="char char-correct${isSpace ? ' char-space' : ''}">${correctChar === ' ' ? ' ' : correctChar}</span>`;
        } else {
            correctLine += `<span class="char${isSpace ? ' char-space' : ''}">${correctChar === ' ' ? ' ' : correctChar}</span>`;
        }
    }
    correctLine += '</div>';
    return userLine + arrow + correctLine;
}
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏
function checkTypingAnswer(inputEl, expectedAnswer, comparisonEl) {
    const userAnswer = inputEl.value.trim();
    const isCorrect = userAnswer.toLowerCase() === expectedAnswer.toLowerCase();
    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
    inputEl.classList.remove('correct', 'incorrect');
    setTimeout(() => {
        inputEl.classList.add(isCorrect ? 'correct' : 'incorrect');
    }, 10);
    // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
    if (comparisonEl) {
        comparisonEl.innerHTML = compareStringsAnkiStyle(userAnswer, expectedAnswer);
        comparisonEl.style.display = 'block';
    }
    // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ SRS
    const card = inputEl.closest('.card');
    const wordId = card.dataset.wordId;
    storage.getProgress(wordId).then(prog => {
        prog = prog || {level: 0, lastReview: Date.now(), nextReview: Date.now()};
        updateProgress(prog, isCorrect);
        storage.setProgress(wordId, prog).then(() => {
            progressMap.set(wordId, {...prog});
        });
    }).catch(console.error);
}
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤
function checkExampleTypingAnswer(inputEl, expectedAnswer, comparisonEl) {
    const userAnswer = inputEl.value.trim();
    const isCorrect = userAnswer.toLowerCase() === expectedAnswer.toLowerCase();
    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
    inputEl.classList.remove('correct', 'incorrect');
    setTimeout(() => {
        inputEl.classList.add(isCorrect ? 'correct' : 'incorrect');
    }, 10);
    // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
    if (comparisonEl) {
        comparisonEl.innerHTML = compareStringsAnkiStyle(userAnswer, expectedAnswer);
        comparisonEl.style.display = 'block';
    }
}
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø–µ—á–∞—Ç–∏
async function toggleTypingMode() {
    typingModeActive = !typingModeActive;
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
    const typingBtn = document.getElementById("typingBtn");
    const typingBtnSide = document.getElementById("typingBtnSide");
    if (typingModeActive) {
        typingBtn.classList.add("active");
        typingBtnSide.classList.add("active");
        typingBtn.innerHTML = "‚èπÔ∏è –í—ã–∫–ª—é—á–∏—Ç—å –ø–µ—á–∞—Ç—å";
        typingBtnSide.innerHTML = "‚èπÔ∏è –í—ã–∫–ª—é—á–∏—Ç—å –ø–µ—á–∞—Ç—å";
    } else {
        typingBtn.classList.remove("active");
        typingBtnSide.classList.remove("active");
        typingBtn.innerHTML = "‚å®Ô∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–µ—á–∞—Ç–∏";
        typingBtnSide.innerHTML = "‚å®Ô∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–µ—á–∞—Ç–∏";
    }
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    await storage.set(STORAGE_KEYS.TYPING_MODE, typingModeActive);
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    renderPage(currentPage);
}
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Å–∫—Ä—ã—Ç–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
async function toggleHideEnglishMode() {
    hideEnglishMode = !hideEnglishMode;
    const isActive = hideEnglishMode;
    const mainBtn = document.getElementById("hideEnglishBtn");
    const sideBtn = document.getElementById("hideEnglishBtnSide");
    if (isActive) {
        mainBtn.classList.add("active");
        sideBtn.classList.add("active");
        mainBtn.textContent = "üôà –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π";
        sideBtn.textContent = "üôà –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π";
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        document.body.classList.add("hide-english");
    } else {
        mainBtn.classList.remove("active");
        sideBtn.classList.remove("active");
        mainBtn.textContent = "üôà –°–∫—Ä—ã—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π";
        sideBtn.textContent = "üôà –°–∫—Ä—ã—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π";
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        document.body.classList.remove("hide-english");
    }
    await storage.set(STORAGE_KEYS.HIDE_ENGLISH, hideEnglishMode);
}
function selectNode(el){
    const range = document.createRange();
    range.selectNodeContents(el);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
}
function selectSingleWordFromEvent(e, el){
    const text = el.textContent;
    const node = el.firstChild;
    if (!node || node.nodeType !== Node.TEXT_NODE) return text.trim();
    const pos = document.caretPositionFromPoint
        ? document.caretPositionFromPoint(e.clientX, e.clientY)
        : null;
    if (!pos || pos.offsetNode !== node) {
        return text.trim().split(/\s+/)[0];
    }
    const i = pos.offset;
    let L = i;
    while (L > 0 && /[\w'-]/.test(text[L-1])) L--;
    let R = i;
    while (R < text.length && /[\w'-]/.test(text[R])) R++;
    const range = document.createRange();
    range.setStart(node, L);
    range.setEnd(node, R);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    return text.slice(L, R).trim();
}
function highlightSearch(text, search) {
    if (!search) return text;
    const regex = new RegExp(search, 'gi');
    return text.replace(regex, match =>
        `<span style="background: rgba(251, 113, 133, 0.3); border-radius: 3px; padding: 0 2px;">${match}</span>`
    );
}
function jumpToCard() {
    const cardNumber = parseInt(document.getElementById('cardJumpInput').value);
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–∞
    if (!cardNumber || cardNumber < 1) {
        const errorMessage = document.createElement('div');
        errorMessage.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 100, 100, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: fadeInOut 3s ease-in-out;
        `;
        errorMessage.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Å–ª–æ–≤–∞';
        document.body.appendChild(errorMessage);
        setTimeout(() => {
            errorMessage.remove();
        }, 3000);
        return;
    }
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º –µ—ë
    const pageNumber = Math.ceil(cardNumber / PAGE_SIZE);
    currentPage = pageNumber;
    renderPage(pageNumber);
    // –ü–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω—É–∂–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ
    setTimeout(() => {
        const cardIndex = (cardNumber - 1) % PAGE_SIZE;
        const cards = document.querySelectorAll('.card');
        if (cards[cardIndex]) {
            // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ
            cards[cardIndex].scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
            cards[cardIndex].style.transition = 'all 0.3s ease';
            cards[cardIndex].style.boxShadow = '0 0 0 3px var(--accent)';
            cards[cardIndex].style.transform = 'scale(1.01)';
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                cards[cardIndex].style.boxShadow = '';
                cards[cardIndex].style.transform = '';
            }, 2000);
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('cardJumpInput').focus();
        }
    }, 300);
}
// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
function stopContinuousPlayback() {
    continuousPlaybackActive = false;
    if (continuousTimeout) {
        clearTimeout(continuousTimeout);
        continuousTimeout = null;
    }
    // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    document.querySelectorAll('.highlight-playing').forEach(el => {
        el.classList.remove('highlight-playing');
    });
}
// –ó–∞–ø—É—Å–∫ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
function startContinuousPlayback(elements, startIndex) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –∞–∫—Ç–∏–≤–µ–Ω
    stopContinuousPlayback();
    continuousPlaybackActive = true;
    continuousElements = elements;
    currentContinuousIndex = startIndex;
    // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    playNextInSequence();
}
// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
function playNextInSequence() {
    if (!continuousPlaybackActive || currentContinuousIndex >= continuousElements.length) {
        stopContinuousPlayback();
        return;
    }
    const element = continuousElements[currentContinuousIndex];
    // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
    document.querySelectorAll('.highlight-playing').forEach(el => {
        el.classList.remove('highlight-playing');
    });
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Ç–µ–∫—É—â–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
    element.classList.add('highlight-playing');
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ç–µ–∫—É—â–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É, –µ—Å–ª–∏ –æ–Ω –≤–Ω–µ –ø–æ–ª—è –∑—Ä–µ–Ω–∏—è
    if (continuousMode && currentContinuousIndex > 0) {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç
    if (element.dataset.speak) {
        speakText(element.dataset.speak, () => {
            if (continuousPlaybackActive) {
                continuousTimeout = setTimeout(() => {
                    currentContinuousIndex++;
                    playNextInSequence();
                }, continuousDelay * 1000); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            }
        });
    }
}
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
function handleSpeakElementClick(el, e) {
    e.stopPropagation();
    if (continuousMode) {
        // –ï—Å–ª–∏ —É–∂–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —ç—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
        if (continuousPlaybackActive && continuousElements.includes(el)) {
            stopContinuousPlayback();
            return;
        }
        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤–æ –≤—Å–µ–º —Å–ø–∏—Å–∫–µ
        const allElements = Array.from(document.querySelectorAll('.word-en, .en'));
        const startIndex = allElements.indexOf(el);
        if (startIndex !== -1) {
            // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å —ç—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            startContinuousPlayback(allElements, startIndex);
        }
    } else {
        // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
        selectNode(el);
        speakText(el.dataset.speak);
    }
    if (el.classList.contains('word-en')) {
        const card = el.closest('.card');
        const wordId = card.dataset.wordId;
        storage.getProgress(wordId).then(prog => {
            prog = prog || {level: 0, lastReview: Date.now(), nextReview: Date.now()};
            updateProgress(prog, true);
            // RULE:
            // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–ø–∏—Å–∏ progress –≤ storage,
            // UI-—Å–ª–æ–π –û–ë–Ø–ó–ê–ù –æ–±–Ω–æ–≤–∏—Ç—å progressMap –≤—Ä—É—á–Ω—É—é.
            // –≠—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Å–∫—Ä—ã—Ç—ã—Ö side-effects.
            storage.setProgress(wordId, prog).then(() => {
                progressMap.set(wordId, {...prog});
            });
        }).catch(console.error);
    }
}
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
async function toggleContinuousMode() {  // –£–ª—É—á—à–µ–Ω–∏–µ: –°–¥–µ–ª–∞–Ω–æ async –¥–ª—è await storage.set.
    continuousMode = !continuousMode;
    const isActive = continuousMode;
    const mainBtn = document.getElementById("continuousBtn");
    const sideBtn = document.getElementById("continuousBtnSide");
    if (isActive) {
        mainBtn.classList.add("continuous-active");
        sideBtn.classList.add("continuous-active");
        mainBtn.textContent = "‚èπÔ∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞";
        sideBtn.textContent = "‚èπÔ∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞";
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active –¥–ª—è —Ä–æ–∑–æ–≤–æ–≥–æ —Ñ–æ–Ω–∞
        mainBtn.classList.add("active");
        sideBtn.classList.add("active");
    } else {
        mainBtn.classList.remove("continuous-active");
        sideBtn.classList.remove("continuous-active");
        mainBtn.classList.remove("active");
        sideBtn.classList.remove("active");
        mainBtn.textContent = "‚ñ∂Ô∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞";
        sideBtn.textContent = "‚ñ∂Ô∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞";
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞
        stopContinuousPlayback();
    }
    await storage.set(STORAGE_KEYS.CONTINUOUS_MODE, continuousMode);
}

function renderPage(page){
    currentPage = page;
    const container = document.getElementById("container");
    container.innerHTML = "";
    stopContinuousPlayback(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

    if (filteredData.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--muted);">üì≠ –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        updateStats();
        return;
    }

    const start = (page-1) * PAGE_SIZE;
    const slice = filteredData.slice(start, start + PAGE_SIZE);

    slice.forEach((item, i) => {
        const globalIndex = allData.findIndex(d => d.word === item.word) + 1;
        const encoded20 = encodeURIComponent(item.word);
        const encodedPlus = item.word.replace(/ /g, '+');
        const encodedUnder = item.word.replace(/ /g, '_');
        const youglish = `https://youglish.com/pronounce/${encodedUnder}/english`;
        const playphrase = `https://www.playphrase.me/#/search?q=${encodedPlus}&language=en`;
        const yandexTrans = `https://translate.yandex.ru/?source_lang=en&target_lang=ru&text=${encoded20}`;
        const transRu = `https://www.translate.ru/–∫–æ–Ω—Ç–µ–∫—Å—Ç—ã/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π-—Ä—É—Å—Å–∫–∏–π/${encoded20}`;
        const kartaslov = `https://en.kartaslov.ru/–ø–µ—Ä–µ–≤–æ–¥-–≤-–∫–æ–Ω—Ç–µ–∫—Å—Ç–µ/${encodedPlus}`;
        const reverso = `https://context.reverso.net/–ø–µ—Ä–µ–≤–æ–¥/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π-—Ä—É—Å—Å–∫–∏–π/${encodedPlus}`;
        const wooordhunt = `https://wooordhunt.ru/word/${encoded20}`;
        const forvo = `https://ru.forvo.com/search/${encoded20}/`;
        const yandexImages = `https://yandex.ru/images/search?text=${encoded20}`;

        const card = document.createElement("div");
        card.className = "card";
        card.dataset.wordId = item.word;

        // –î–æ–±–∞–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞, –µ—Å–ª–∏ —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω
        const checkboxHTML = exportModeActive ? 
            `<input type="checkbox" class="export-checkbox" id="export-${item.word}" 
             onchange="toggleCardSelection('${item.word.replace(/'/g, "\\'")}', this)"
             ${selectedCards.has(item.word) ? 'checked' : ''}>` : '';

        const examplesToShow = (currentTags.length === 0 && !currentTheme && !currentSearch)
            ? item.examples.slice(0, 4)
            : item.examples;

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤ —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π –ø–µ—á–∞—Ç–∏
        let examplesHTML = '';
        examplesToShow.forEach((ex, exIndex) => {
            const ipaText = ex.ipa ? ex.ipa : '';
            const ipaHTML = ipaText ? `<div class="ipa">${ipaText}</div>` : '';
            const exampleSyllablesHTML = showSyllables && ex.syllables
                ? `
                <div class="example-syllables">
                ${ex.syllables.split('¬∑').map((syllable, i) => `
                    <span class="syllable ${ex.stress && ex.stress.includes(i) ? 'stressed' : ''}">${syllable}</span>
                `).join('¬∑')}
                </div>
                `
                : '';
            const enText = currentSearch ? highlightSearch(ex.en, currentSearch) : ex.en;
            const ruText = currentSearch ? highlightSearch(ex.ru, currentSearch) : ex.ru;

            // HTML –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø–µ—á–∞—Ç–∏ –ø—Ä–∏–º–µ—Ä–∞
            const exampleTypingHTML = typingModeActive ? `
                <div class="example-typing-container" style="display: block;">
                    <div class="typing-input-group">
                        <input
                            type="text"
                            class="typing-input example-typing-input"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º..."
                            data-correct="${ex.en.replace(/"/g, '&quot;')}"
                            data-example-index="${exIndex}"
                        >
                    </div>
                    <div class="typing-hint">–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞</div>
                    <div class="typing-comparison example-typing-comparison" style="display: none;"></div>
                </div>
            ` : '';

            examplesHTML += `
            <div class="example">
                <div class="en" data-speak="${ex.en}">${enText}</div>
                ${exampleSyllablesHTML}
                ${ipaHTML}
                <div class="ru translation">${ruText}</div>
                <button class="show-translation-btn" onclick="showTranslation(this)">Show</button>
                ${exampleTypingHTML}
            </div>
            `;
        });

        const tagsHTML = item.tags && item.tags.length > 0 ? `
            <div class="word-tags">
            ${item.tags.map(tag => `
                <span class="word-tag" onclick="addTagFromCard('${tag.replace(/'/g, "\\'")}')">${tag}</span>
            `).join('')}
            </div>
        ` : '';

        const syllablesHTML = item.syllables && showSyllables
            ? `
            <div class="syllables">
            ${item.syllables.split('¬∑').map((syllable, i) => `
                <span class="syllable ${i === item.stress ? 'stressed' : ''}">${syllable}</span>
            `).join('¬∑')}
            </div>
            `
            : '';

        const ipaHTML = item.ipa ? `<div class="ipa">${item.ipa}</div>` : '';
        const wordEnHTML = currentSearch ? highlightSearch(item.word, currentSearch) : item.word;
        const wordRuHTML = currentSearch ? highlightSearch(item.translation, currentSearch) : item.translation;

        const cardIndexHTML = isMobileView
            ? `
            <div class="card-index">
            <div>
            <a href="${youglish}" target="_blank" title="YouGlish">
            <img src="img/youglish.png" alt="YouGlish" class="service-icon">
            </a>
            <a href="${playphrase}" target="_blank" title="PlayPhrase">
            <img src="img/playphrase.png" alt="PlayPhrase" class="service-icon">
            </a>
            <a href="${yandexTrans}" target="_blank" title="–Ø–Ω–¥–µ–∫—Å –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫">
            <img src="img/yandex.png" alt="–Ø–Ω–¥–µ–∫—Å –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫" class="service-icon">
            </a>
            <a href="${transRu}" target="_blank" title="Translate.ru">
            <img src="img/translateru.png" alt="Translate.ru" class="service-icon">
            </a>
            <a href="${kartaslov}" target="_blank" title="Kartaslov">
            <img src="img/kartaslov.png" alt="Kartaslov" class="service-icon">
            </a>
            <a href="${reverso}" target="_blank" title="Reverso Context">
            <img src="img/reverso.png" alt="Reverso" class="service-icon">
            </a>
            <a href="${wooordhunt}" target="_blank" title="WooordHunt">
            <img src="img/wooordhunt.png" alt="WooordHunt" class="service-icon">
            </a>
            <a href="${forvo}" target="_blank" title="Forvo">
            <img src="img/forvo.png" alt="Forvo" class="service-icon">
            </a>
            <a href="${yandexImages}" target="_blank" title="–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∏–Ω–∫–∏">
            <img src="img/yandex-images.png" alt="–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∏–Ω–∫–∏" class="service-icon">
            </a>
            </div>
            <span class="index-num">${globalIndex}</span>
            </div>
            `
            : `
            <div class="card-index">
            <a href="${youglish}" target="_blank" title="YouGlish - –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è –∏–∑ –≤–∏–¥–µ–æ">
            <img src="img/youglish.png" alt="YouGlish" class="service-icon">
            </a>
            <a href="${playphrase}" target="_blank" title="PlayPhrase - —Ñ—Ä–∞–∑—ã –∏–∑ —Ñ–∏–ª—å–º–æ–≤">
            <img src="img/playphrase.png" alt="PlayPhrase" class="service-icon">
            </a>
            <a href="${yandexTrans}" target="_blank" title="–Ø–Ω–¥–µ–∫—Å –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫">
            <img src="img/yandex.png" alt="–Ø–Ω–¥–µ–∫—Å –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫" class="service-icon">
            </a>
            <a href="${transRu}" target="_blank" title="Translate.ru">
            <img src="img/translateru.png" alt="Translate.ru" class="service-icon">
            </a>
            <a href="${kartaslov}" target="_blank" title="Kartaslov - –ø–µ—Ä–µ–≤–æ–¥ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ">
            <img src="img/kartaslov.png" alt="Kartaslov" class="service-icon">
            </a>
            <a href="${reverso}" target="_blank" title="Reverso Context">
            <img src="img/reverso.png" alt="Reverso" class="service-icon">
            </a>
            <a href="${wooordhunt}" target="_blank" title="WooordHunt">
            <img src="img/wooordhunt.png" alt="WooordHunt" class="service-icon">
            </a>
            <a href="${forvo}" target="_blank" title="Forvo - –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ –æ—Ç –Ω–æ—Å–∏—Ç–µ–ª–µ–π">
            <img src="img/forvo.png" alt="Forvo" class="service-icon">
            </a>
            <a href="${yandexImages}" target="_blank" title="–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∏–Ω–∫–∏">
            <img src="img/yandex-images.png" alt="–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∏–Ω–∫–∏" class="service-icon">
            </a>
            <span class="index-num">${globalIndex}</span>
            </div>
            `;

        card.innerHTML = `
            ${checkboxHTML}
            ${cardIndexHTML}
            ${tagsHTML}
            <div class="word-line">
            <span class="word-en" data-speak="${item.word}">${wordEnHTML}</span>
            ${syllablesHTML}
            ${ipaHTML}
            <span class="word-ru translation">${wordRuHTML}</span>
            <button class="show-translation-btn" onclick="showTranslation(this)">Show</button>
            </div>
            <div class="examples">
            ${examplesHTML}
            </div>
        `;

        container.appendChild(card);

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø–µ—á–∞—Ç–∏ —Å–ª–æ–≤–∞ (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω)
        if (typingModeActive) {
            const typingHTML = `
                <div class="typing-container" style="display: block;">
                <div class="typing-input-group">
                <input
                    type="text"
                    class="typing-input"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º..."
                    data-correct="${item.word.replace(/"/g, '&quot;')}"
                >
                </div>
                <div class="typing-hint">–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞</div>
                <div class="typing-comparison" style="display: none;"></div>
                </div>
            `;
            // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ—Ä–∞–º–∏
            const wordLine = card.querySelector('.word-line');
            if (wordLine) {
                wordLine.insertAdjacentHTML('afterend', typingHTML);
            }
        }
    });

    document.querySelectorAll(".word-en, .en").forEach(el => {
        el.onclick = (e) => handleSpeakElementClick(el, e);
        el.ondblclick = e => {
            e.preventDefault();
            e.stopPropagation();
            // –í—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º –∫–ª–∏–∫–µ
            stopContinuousPlayback();
            const w = selectSingleWordFromEvent(e, el);
            speakText(w);
        };
        el.title = continuousMode ?
            "–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –æ–∑–≤—É—á–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–ª–æ–≤–∞." :
            el.title;
    });

    document.querySelectorAll(".word-ru, .ru")
        .forEach(el => el.onclick = () => selectNode(el));

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø–µ—á–∞—Ç–∏ —Å–ª–æ–≤–∞ (–ë–ï–ó –ê–í–¢–û–§–û–ö–£–°–ò–†–û–í–ö–ò)
    if (typingModeActive) {
        document.querySelectorAll('.typing-input:not(.example-typing-input)').forEach((input, index) => {
            const comparisonEl = input.closest('.typing-container').querySelector('.typing-comparison');
            const correctAnswer = input.dataset.correct;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && input.value.trim() !== '') {
                    checkTypingAnswer(input, correctAnswer, comparisonEl);
                }
            });
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø–µ—á–∞—Ç–∏ –ø—Ä–∏–º–µ—Ä–æ–≤
        document.querySelectorAll('.example-typing-input').forEach((input) => {
            const exampleContainer = input.closest('.example');
            const comparisonEl = exampleContainer.querySelector('.example-typing-comparison');
            const correctAnswer = input.dataset.correct;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && input.value.trim() !== '') {
                    checkExampleTypingAnswer(input, correctAnswer, comparisonEl);
                }
            });
        });
    }

    updateStats();
    updatePaginationUI();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
    if (exportModeActive) {
        updateExportCounter();
    }
}

function addTagFromCard(tag) {
    if (!currentTags.includes(tag)) {
        currentTags.push(tag);
        const tagFilter = document.getElementById('tagFilter');
        Array.from(tagFilter.options).forEach(option => {
            if (option.value === tag) {
                option.selected = true;
            }
        });
        updateSelectedTagsDisplay();
        applyFilters();
    }
}
function buildPagination() {
    const total = Math.ceil(filteredData.length / PAGE_SIZE);
    const pag = document.getElementById("pagination");
    pag.innerHTML = "";
    for (let i = 1; i <= total; i++) {
        const b = document.createElement("button");
        b.textContent = i;
        b.className = "page-btn";
        b.onclick = () => renderPage(i);
        pag.appendChild(b);
    }
}
function updatePaginationUI() {
    document.querySelectorAll(".page-btn")
        .forEach(btn => {
            btn.classList.toggle("active", btn.textContent == currentPage);
        });
}
// INVARIANT: testMode is session-only (temporary UI state, not persisted across sessions, to avoid unexpected behavior on reload).
let testMode = false;
async function toggleTestMode() {  // –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: –°–¥–µ–ª–∞–Ω–æ async, –Ω–æ –ø–æ—Å–∫–æ–ª—å–∫—É testMode session-only, –Ω–µ—Ç storage.set (–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å persistency).
    testMode = !testMode;
    document.body.classList.toggle("hide-ru", testMode);
    const txt = testMode
        ? "üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã"
        : "üß† –°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞";
    document.getElementById("testBtn").textContent = txt;
    document.getElementById("testBtnSide").textContent = txt;
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
    const testBtn = document.getElementById("testBtn");
    const testBtnSide = document.getElementById("testBtnSide");
    if (testMode) {
        testBtn.classList.add("active");
        testBtnSide.classList.add("active");
    } else {
        testBtn.classList.remove("active");
        testBtnSide.classList.remove("active");
    }
    if (!testMode) {
        resetTranslations();
    }
}
function resetTranslations() {
    document.querySelectorAll('.translation').forEach(el => el.classList.remove('shown'));
    document.querySelectorAll('.show-translation-btn').forEach(btn => btn.classList.remove('hidden'));
}
function showTranslation(btn) {
    const translation = btn.previousElementSibling;
    if (translation && translation.classList.contains('translation')) {
        translation.classList.add('shown');
        btn.classList.add('hidden');
    }
    const card = btn.closest('.card');
    const wordId = card.dataset.wordId;
    storage.getProgress(wordId).then(prog => {
        prog = prog || {level: 0, lastReview: Date.now(), nextReview: Date.now()};
        updateProgress(prog, false); // Looked at translation, not remembered
        storage.setProgress(wordId, prog).then(() => {
            progressMap.set(wordId, {...prog});
        });
    }).catch(console.error);
}
async function toggleTheme() {  // –£–ª—É—á—à–µ–Ω–∏–µ: –°–¥–µ–ª–∞–Ω–æ async –¥–ª—è await storage.set.
    const cur = document.documentElement.getAttribute("data-theme");
    const next = cur === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", next);
    await storage.set(STORAGE_KEYS.THEME, next);
}
let isSettingsOpen = false;
function toggleSettings() {
    const panel = document.getElementById("sidePanel");
    if (isSettingsOpen) {
        panel.classList.remove("open");
        setTimeout(() => panel.style.display = "none", 300);
    } else {
        panel.style.display = "flex";
        setTimeout(() => panel.classList.add("open"), 10);
    }
    isSettingsOpen = !isSettingsOpen;
}
const rateSlider = document.getElementById("rateSlider");
const pitchSlider = document.getElementById("pitchSlider");
const rateLabel = document.getElementById("rateLabel");
const pitchLabel = document.getElementById("pitchLabel");
const rateSliderSide = document.getElementById("rateSliderSide");
const pitchSliderSide = document.getElementById("pitchSliderSide");
const rateLabelSide = document.getElementById("rateLabelSide");
const pitchLabelSide = document.getElementById("pitchLabelSide");
const delaySlider = document.getElementById("delaySlider");
const delaySliderSide = document.getElementById("delaySliderSide");
const delayLabel = document.getElementById("delayLabel");
const delayLabelSide = document.getElementById("delayLabelSide");
// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏
// (—Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ storage, –ø–æ—Å–ª–µ init)
function updateLabels() {
    rateLabel.textContent = `x${parseFloat(rateSlider.value).toFixed(2)}`;
    pitchLabel.textContent = parseFloat(pitchSlider.value).toFixed(2);
    delayLabel.textContent = `${parseFloat(delaySlider.value).toFixed(1)}s`;
    rateLabelSide.textContent = `x${parseFloat(rateSliderSide.value).toFixed(2)}`;
    pitchLabelSide.textContent = parseFloat(pitchSliderSide.value).toFixed(2);
    delayLabelSide.textContent = `${parseFloat(delaySliderSide.value).toFixed(1)}s`;
}
updateLabels();
rateSlider.oninput = async () => {  // –£–ª—É—á—à–µ–Ω–∏–µ: Await –¥–ª—è storage.set.
    rateSliderSide.value = rateSlider.value;
    await storage.set(STORAGE_KEYS.TTS_RATE, rateSlider.value);
    updateLabels();
};
pitchSlider.oninput = async () => {  // –£–ª—É—á—à–µ–Ω–∏–µ: Await –¥–ª—è storage.set.
    pitchSliderSide.value = pitchSlider.value;
    await storage.set(STORAGE_KEYS.TTS_PITCH, pitchSlider.value);
    updateLabels();
};
delaySlider.oninput = async () => {  // –£–ª—É—á—à–µ–Ω–∏–µ: Await –¥–ª—è storage.set.
    continuousDelay = parseFloat(delaySlider.value);
    delaySliderSide.value = continuousDelay;
    await storage.set(STORAGE_KEYS.CONTINUOUS_DELAY, continuousDelay);
    updateLabels();
};
rateSliderSide.oninput = async () => {  // –£–ª—É—á—à–µ–Ω–∏–µ: Await –¥–ª—è storage.set.
    rateSlider.value = rateSliderSide.value;
    await storage.set(STORAGE_KEYS.TTS_RATE, rateSlider.value);
    updateLabels();
};
pitchSliderSide.oninput = async () => {  // –£–ª—É—á—à–µ–Ω–∏–µ: Await –¥–ª—è storage.set.
    pitchSlider.value = pitchSliderSide.value;
    await storage.set(STORAGE_KEYS.TTS_PITCH, pitchSlider.value);
    updateLabels();
};
delaySliderSide.oninput = async () => {  // –£–ª—É—á—à–µ–Ω–∏–µ: Await –¥–ª—è storage.set.
    continuousDelay = parseFloat(delaySliderSide.value);
    delaySlider.value = continuousDelay;
    await storage.set(STORAGE_KEYS.CONTINUOUS_DELAY, continuousDelay);
    updateLabels();
};
const voiceSelect = document.getElementById("voiceSelect");
const voiceSelectSide = document.getElementById("voiceSelectSide");
let VOICES = [];
const NAME_MAP = {
    "Ava": "Ava", "Nathan": "Nathan", "Alex": "–ê–ª–µ–∫—Å", "–ê–ª–µ–∫—Å": "–ê–ª–µ–∫—Å",
    "Zoe": "–ó–æ–∏", "–ó–æ–∏": "–ó–æ–∏", "Nikki": "–ù–∏–∫–∫–∏", "Nicky": "–ù–∏–∫–∫–∏",
    "–ù–∏–∫–∫–∏": "–ù–∏–∫–∫–∏", "Samantha": "–°–∞–º–∞–Ω—Ç–∞", "–°–∞–º–∞–Ω—Ç–∞": "–°–∞–º–∞–Ω—Ç–∞",
    "Susan": "–°—å—é–∑–µ–Ω", "–°—å—é–∑–µ–Ω": "–°—å—é–∑–µ–Ω", "Tom": "–¢–æ–º", "–¢–æ–º": "–¢–æ–º",
    "Evan": "–≠–≤–∞–Ω", "–≠–≤–∞–Ω": "–≠–≤–∞–Ω", "Alison": "–≠–ª–∏—Å–æ–Ω", "–≠–ª–∏—Å–æ–Ω": "–≠–ª–∏—Å–æ–Ω"
};
const GENDER_ICON = {
    "–¢–æ–º": "üë®", "–≠–≤–∞–Ω": "üë®", "Nathan": "üë®", "–ê–ª–µ–∫—Å": "üë®",
    "–ù–∏–∫–∫–∏": "üë©", "–°–∞–º–∞–Ω—Ç–∞": "üë©", "–ó–æ–∏": "üë©", "Ava": "üë©",
    "–°—å—é–∑–µ–Ω": "üë©", "–≠–ª–∏—Å–æ–Ω": "üë©"
};
const DISPLAY_ORDER = [
    "–¢–æ–º", "–≠–≤–∞–Ω", "Nathan", "–ê–ª–µ–∫—Å", "SEPARATOR",
    "–ù–∏–∫–∫–∏", "–°–∞–º–∞–Ω—Ç–∞", "–ó–æ–∏", "Ava", "–°—å—é–∑–µ–Ω", "–≠–ª–∏—Å–æ–Ω"
];
async function populateDesktopVoices() {  // –£–ª—É—á—à–µ–Ω–∏–µ: –°–¥–µ–ª–∞–Ω–æ async –¥–ª—è await storage.get.
    const allVoices = window.speechSynthesis.getVoices();
    if (!allVoices.length) return;
    const matched = allVoices.filter(v =>
        v.lang === "en-US" &&
        Object.keys(NAME_MAP).some(k => v.name.includes(k))
    );
    VOICES = matched;
    voiceSelect.innerHTML = "";
    voiceSelectSide.innerHTML = "";
    const items = VOICES.map((v, i) => {
        const short =
            Object.entries(NAME_MAP).find(([k]) => v.name.includes(k))?.[1] || v.name;
        const icon = GENDER_ICON[short] || "";
        return { index: i, label: icon ? `${icon} ${short}` : short, short };
    });
    DISPLAY_ORDER.forEach(name => {
        if (name === "SEPARATOR") {
            const s = document.createElement("option");
            s.textContent = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
            s.disabled = true;
            voiceSelect.appendChild(s);
            voiceSelectSide.appendChild(s.cloneNode(true));
            return;
        }
        const f = items.find(it => it.short === name);
        if (f) {
            const o = document.createElement("option");
            o.value = f.index;
            o.textContent = f.label;
            voiceSelect.appendChild(o);
            voiceSelectSide.appendChild(o.cloneNode(true));
        }
    });
    const mute = document.createElement("option");
    mute.value = "mute";
    mute.textContent = "üîá –ë–µ–∑ –æ–∑–≤—É—á–∫–∏";
    voiceSelect.appendChild(mute);
    voiceSelectSide.appendChild(mute.cloneNode(true));
    const savedVoice = await storage.get(STORAGE_KEYS.TTS_VOICE);
    const tom = VOICES.findIndex(v => v.name.includes("Tom"));
    const def = tom !== -1 ? tom : "mute";
    voiceSelect.value = savedVoice || def;
    voiceSelectSide.value = savedVoice || def;
}
async function populateAndroidVoices() {  // –£–ª—É—á—à–µ–Ω–∏–µ: –°–¥–µ–ª–∞–Ω–æ async –¥–ª—è await storage.set.
    voiceSelect.innerHTML = "";
    voiceSelectSide.innerHTML = "";
    const mute = document.createElement("option");
    mute.value = "mute";
    mute.textContent = "üîá –ë–µ–∑ –æ–∑–≤—É—á–∫–∏";
    voiceSelect.appendChild(mute);
    voiceSelectSide.appendChild(mute.cloneNode(true));
    const systemOption = document.createElement("option");
    systemOption.value = "system";
    systemOption.textContent = "üì± –°–∏—Å—Ç–µ–º–Ω—ã–π Google TTS (Android)";
    voiceSelect.appendChild(systemOption);
    voiceSelectSide.appendChild(systemOption.cloneNode(true));
    voiceSelect.value = "system";
    voiceSelectSide.value = "system";
    await storage.set(STORAGE_KEYS.TTS_VOICE, "system");
}
function initVoices() {
    if (isAndroid) {
        populateAndroidVoices();
    } else {
        window.addEventListener("load", () => {
            const warmup = new SpeechSynthesisUtterance(" ");
            warmup.volume = 0;
            window.speechSynthesis.speak(warmup);
            setTimeout(populateDesktopVoices, 300);
            setTimeout(populateDesktopVoices, 800);
            setTimeout(populateDesktopVoices, 1500);
        });
        window.speechSynthesis.onvoiceschanged = populateDesktopVoices;
    }
}
voiceSelect.onchange = async () => {  // –£–ª—É—á—à–µ–Ω–∏–µ: Await –¥–ª—è storage.set.
    voiceSelectSide.value = voiceSelect.value;
    await storage.set(STORAGE_KEYS.TTS_VOICE, voiceSelect.value);
};
voiceSelectSide.onchange = async () => {  // –£–ª—É—á—à–µ–Ω–∏–µ: Await –¥–ª—è storage.set.
    voiceSelect.value = voiceSelectSide.value;
    await storage.set(STORAGE_KEYS.TTS_VOICE, voiceSelect.value);
};
function speakText(text, onEndCallback) {
    if (voiceSelect.value === "mute") {
        if (onEndCallback) onEndCallback();
        return;
    }
    const synth = window.speechSynthesis;
    synth.cancel();
    if (isAndroid) {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "en-US";
        u.rate = parseFloat(rateSlider.value);
        u.pitch = parseFloat(pitchSlider.value);
        u.volume = 1.0;
        if (onEndCallback) {
            u.onend = onEndCallback;
        }
        synth.speak(u);
    } else {
        const idx = parseInt(voiceSelect.value, 10);
        const voice = VOICES[idx] || VOICES[0];
        const u = new SpeechSynthesisUtterance(text);
        u.voice = voice;
        u.lang = "en-US";
        u.rate = parseFloat(rateSlider.value);
        u.pitch = parseFloat(pitchSlider.value);
        u.volume = 1.0;
        if (onEndCallback) {
            u.onend = onEndCallback;
        }
        synth.speak(u);
    }
}
document.getElementById('searchInput').addEventListener('input', function(e) {
    currentSearch = e.target.value.trim();
    currentPage = 1;
    applyFilters();
});
// Main init: Await storage.init() –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º/—Ä–µ–Ω–¥–µ—Ä–æ–º.
(async () => {
    await storage.init(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è + –º–∏–≥—Ä–∞—Ü–∏—è (–î–û –≤—Å–µ–≥–æ).
    const allProgress = await storage.getAllProgress();
    progressMap = new Map(allProgress.map(p => [p.wordId, p]));
    // –¢–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ —á–∏—Ç–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—á–µ—Ä–µ–∑ abstraction).
    const savedTheme = await storage.get(STORAGE_KEYS.THEME);
    if (savedTheme) document.documentElement.setAttribute("data-theme", savedTheme);
    const savedIpa = await storage.get(STORAGE_KEYS.SHOW_IPA);
    if (savedIpa !== null) {
        showIpa = savedIpa === "true";
        document.body.classList.toggle("hide-ipa", !showIpa);
        const txt = showIpa
            ? "üôà –°–∫—Ä—ã—Ç—å IPA"
            : "üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å IPA";
        document.getElementById("ipaBtn").textContent = txt;
        document.getElementById("ipaBtnSide").textContent = txt;
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        const ipaBtn = document.getElementById("ipaBtn");
        const ipaBtnSide = document.getElementById("ipaBtnSide");
        if (showIpa) {
            ipaBtn.classList.add("active");
            ipaBtnSide.classList.add("active");
        }
    }
    const savedSyllables = await storage.get(STORAGE_KEYS.SHOW_SYLLABLES);
    if (savedSyllables !== null) {
        showSyllables = savedSyllables === "true";
        document.body.classList.toggle("show-syllables", showSyllables);
        const txt = showSyllables
            ? "üî§ –°–∫—Ä—ã—Ç—å —Å–ª–æ–≥–∏"
            : "üî§ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–≥–∏";
        document.getElementById("syllablesBtn").textContent = txt;
        document.getElementById("syllablesBtnSide").textContent = txt;
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        const syllablesBtn = document.getElementById("syllablesBtn");
        const syllablesBtnSide = document.getElementById("syllablesBtnSide");
        if (showSyllables) {
            syllablesBtn.classList.add("active");
            syllablesBtnSide.classList.add("active");
        }
    }
    const savedContinuousMode = await storage.get(STORAGE_KEYS.CONTINUOUS_MODE);
    if (savedContinuousMode !== null) {
        continuousMode = savedContinuousMode === "true";
    }
    const savedDelay = await storage.get(STORAGE_KEYS.CONTINUOUS_DELAY);
    if (savedDelay !== null) {
        continuousDelay = parseFloat(savedDelay);
    }
    const savedTypingMode = await storage.get(STORAGE_KEYS.TYPING_MODE);
    if (savedTypingMode !== null) {
        typingModeActive = savedTypingMode === "true";
        const typingBtn = document.getElementById("typingBtn");
        const typingBtnSide = document.getElementById("typingBtnSide");
        if (typingModeActive && typingBtn) {
            typingBtn.classList.add("active");
            typingBtnSide.classList.add("active");
            typingBtn.innerHTML = "‚èπÔ∏è –í—ã–∫–ª—é—á–∏—Ç—å –ø–µ—á–∞—Ç—å";
            typingBtnSide.innerHTML = "‚èπÔ∏è –í—ã–∫–ª—é—á–∏—Ç—å –ø–µ—á–∞—Ç—å";
        }
    }
    const savedHideEnglish = await storage.get(STORAGE_KEYS.HIDE_ENGLISH);
    if (savedHideEnglish !== null) {
        hideEnglishMode = savedHideEnglish === "true";
        const mainBtn = document.getElementById("hideEnglishBtn");
        const sideBtn = document.getElementById("hideEnglishBtnSide");
        if (hideEnglishMode && mainBtn) {
            mainBtn.classList.add("active");
            sideBtn.classList.add("active");
            mainBtn.textContent = "üôà –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π";
            sideBtn.textContent = "üôà –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π";
            document.body.classList.add("hide-english");
        } else if (mainBtn) {
            mainBtn.classList.remove("active");
            sideBtn.classList.remove("active");
            mainBtn.textContent = "üôà –°–∫—Ä—ã—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π";
            sideBtn.textContent = "üôà –°–∫—Ä—ã—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π";
            document.body.classList.remove("hide-english");
        }
    }
    rateSlider.value = await storage.get(STORAGE_KEYS.TTS_RATE) || 0.9;
    pitchSlider.value = await storage.get(STORAGE_KEYS.TTS_PITCH) || 1.02;
    delaySlider.value = continuousDelay;
    rateSliderSide.value = rateSlider.value;
    pitchSliderSide.value = pitchSlider.value;
    delaySliderSide.value = continuousDelay;
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    if (continuousMode) {
        document.getElementById("continuousBtn").classList.add("continuous-active");
        document.getElementById("continuousBtnSide").classList.add("continuous-active");
        document.getElementById("continuousBtn").classList.add("active");
        document.getElementById("continuousBtnSide").classList.add("active");
        document.getElementById("continuousBtn").textContent = "‚èπÔ∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞";
        document.getElementById("continuousBtnSide").textContent = "‚èπÔ∏è –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞";
    }
    if (storage.degraded) {
        console.warn('Storage degraded:', storage.lastError);
    }
    detectPlatform();
    initVoices();
    initFilters();
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–ø–æ—Å–ª–µ storage init).
    fetch("data.json")
        .then(r => r.json())
        .then(data => {
            allData = data;
            filteredData = [...allData];
            extractTagsAndThemes();
            updateStats();
            renderPage(1);
            buildPagination();
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
            document.getElementById('container').innerHTML =
                '<div style="text-align: center; padding: 40px; color: var(--muted);">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ data.json</div>';
        });
})();
</script>
</body>
</html>
