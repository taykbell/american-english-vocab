<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–†–µ–∂–∏–º –∫–∞—Ä—Ç–æ—á–µ–∫ | American English Vocabulary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
--bg: #fff1f6;
--card: #ffffff;
--panel: #ffffff;
--text: #3b1f2b;
--muted: #8b6f7a;
--accent: #db2777;
--green: #10b981;
--yellow: #f59e0b;
--red: #ef4444;
--border: #f2d5e3;
--shadow: 0 4px 12px rgba(219,39,119,.08);
--example-bg: rgba(251, 113, 133, 0.05);
}

[data-theme="dark"] {
--bg: #160a10;
--card: #1f0b15;
--panel: #190910;
--text: #f8e6ee;
--muted: #c9a4b2;
--accent: #fb7185;
--green: #34d399;
--yellow: #fbbf24;
--red: #f87171;
--border: #3b1423;
--shadow: 0 4px 12px rgba(0,0,0,.25);
--example-bg: rgba(251, 113, 133, 0.08);
}

* { 
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background .3s, color .3s;
  min-height: 100vh;
  padding: 20px;
  position: relative;
  overflow-x: hidden;
}

/* ===== –®–ê–ü–ö–ê ===== */
.main-header {
  text-align: center;
  margin-bottom: 20px;
  padding-top: 40px;
}

.header-title h1 {
  margin: 0 0 8px;
  font-weight: 700;
  font-size: 2rem;
  color: var(--text);
}

.header-subtitle {
  color: var(--muted);
  font-size: 0.95rem;
  margin-bottom: 20px;
}

/* ===== –ö–ù–û–ü–ö–ò –¢–ï–ú–´ –ò –ù–ê–°–¢–†–û–ï–ö ===== */
.theme-toggle, .settings-toggle {
  position: fixed;
  top: 18px;
  right: 18px;
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  cursor: pointer;
  background: var(--panel);
  color: var(--text);
  box-shadow: 0 2px 8px rgba(219,39,119,.12);
  z-index: 100;
}

.settings-toggle {
  top: 60px;
}

/* ===== –ö–û–ù–¢–ï–ô–ù–ï–† –ö–ê–†–¢–û–ß–ö–ò ===== */
#flashcard-container {
  max-width: 720px;
  margin: 0 auto;
}

/* ===== –ö–ê–†–¢–û–ß–ö–ê (–∫–∞–∫ –≤ index.html) ===== */
.card {
  background: var(--card);
  padding: 24px 28px;
  border-radius: 14px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  margin: 0 auto 20px auto;
  text-align: left;
  position: relative;
  transition: all 0.3s ease;
}

/* ===== –ù–û–ú–ï–† –°–ï–°–°–ò–ò + –ò–ö–û–ù–ö–ò –°–ï–†–í–ò–°–û–í ===== */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
}

.session-info {
  font-size: 14px;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 5px;
}

.session-current {
  font-weight: 700;
  color: var(--accent);
  font-size: 16px;
}

.srs-level {
  background: rgba(16, 185, 129, 0.15);
  color: var(--green);
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  margin-left: 10px;
}

.srs-level.level-0 { 
  background: rgba(239, 68, 68, 0.15);
  color: var(--red);
}
.srs-level.level-1 { 
  background: rgba(245, 158, 11, 0.15);
  color: var(--yellow);
}
.srs-level.level-2 { 
  background: rgba(245, 158, 11, 0.1);
  color: var(--yellow);
}
.srs-level.level-3 { 
  background: rgba(16, 185, 129, 0.1);
  color: var(--green);
}
.srs-level.level-4 { 
  background: rgba(16, 185, 129, 0.07);
  color: var(--green);
}
.srs-level.level-5 { 
  background: rgba(16, 185, 129, 0.05);
  color: var(--green);
}

.card-index {
  text-align: right;
  font-size: 12px;
  line-height: 1.3;
  padding-bottom: 8px;
}

.card-index a {
  text-decoration: none;
  margin-right: 4px;
  transition: all 0.2s;
  display: inline-block;
  vertical-align: middle;
}

.service-icon {
  width: 20px;
  height: 20px;
  object-fit: contain;
  filter: grayscale(50%);
  opacity: 0.5;
  transition: all 0.2s;
  border-radius: 3px;
  background: var(--bg);
  padding: 2px;
  border: 1px solid var(--border);
}

.service-icon:hover {
  filter: grayscale(0%);
  opacity: 1;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.index-num {
  color: var(--text);
  opacity: 0.15;
  margin-left: 8px;
  font-size: 12px;
  vertical-align: middle;
}

/* ===== –¢–ï–ì–ò ===== */
.word-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 15px;
  margin-top: 10px;
}

.word-tag {
  background: rgba(219, 39, 119, 0.1);
  color: var(--accent);
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  border: 1px solid rgba(219, 39, 119, 0.2);
  cursor: pointer;
  transition: all 0.2s;
}

.word-tag:hover {
  background: rgba(219, 39, 119, 0.2);
  transform: translateY(-1px);
}

/* ===== –°–ª–æ–≥–æ–≤–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ ===== */
.syllables {
  font-size: 18px;
  margin: 8px 0;
  color: var(--accent);
  font-weight: 600;
  text-align: left;
}

.syllable {
  display: inline-block;
  margin: 0 2px;
}

.syllable.stressed {
  text-decoration: underline;
  font-weight: 700;
}

.example-syllables {
  font-size: 16px;
  margin: 4px 0 8px 0;
  color: var(--accent);
  font-weight: 600;
  text-align: left;
}

/* ===== –°–û–î–ï–†–ñ–ê–ù–ò–ï –ö–ê–†–¢–û–ß–ö–ò ===== */
.word-line {
  font-size: 21px;
  margin-bottom: 20px;
  padding-bottom: 12px;
  text-align: left;
}

.word-en {
  color: var(--accent);
  cursor: pointer;
  font-weight: 700;
  display: block;
}

.word-ru {
  cursor: pointer;
  display: block;
  margin-top: 12px;
}

/* ===== –ü–†–ò–ú–ï–†–´ –° –§–û–ù–û–í–´–ú–ò –ë–õ–û–ö–ê–ú–ò ===== */
.example {
  margin-bottom: 14px;
  background: var(--example-bg);
  border-radius: 10px;
  padding: 14px 16px;
  border: 1px solid var(--border);
}

.en {
  cursor: pointer;
  color: #9d174d; /* –¶–≤–µ—Ç –∫–∞–∫ –≤ index.html */
  font-weight: 600;
  margin-bottom: 8px;
  line-height: 1.4;
  font-size: 16px;
}

[data-theme="dark"] .en {
  color: var(--green); /* –í —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é green */
}

.ipa {
  font-family: "Lucida Sans Unicode", "Arial Unicode MS", sans-serif;
  color: var(--accent);
  font-size: 18px;
  margin-bottom: 8px;
  padding-left: 8px;
  border-left: 2px solid var(--accent);
  font-style: italic;
  opacity: 0.9;
  line-height: 1.3;
  text-align: left;
}

.ru {
  cursor: pointer;
  color: var(--muted);
  margin-bottom: 0;
  line-height: 1.4;
}

/* ===== –ö–ù–û–ü–ö–ò SRS ===== */
.srs-controls {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin: 30px auto;
  max-width: 720px;
  flex-wrap: wrap;
}

.srs-btn {
  padding: 12px 24px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 160px;
  justify-content: center;
}

.srs-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(219,39,119,.12);
}

.srs-btn-remember {
  background: var(--green);
  color: white;
  border-color: var(--green);
}

.srs-btn-unsure {
  background: var(--yellow);
  color: white;
  border-color: var(--yellow);
}

.srs-btn-forgot {
  background: var(--red);
  color: white;
  border-color: var(--red);
}

/* ===== –†–ï–ñ–ò–ú –ü–ï–ß–ê–¢–ò ===== */
.print-mode-container {
  background: var(--panel);
  border-radius: 12px;
  padding: 24px;
  margin: 20px auto;
  max-width: 720px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  display: none;
}

.print-russian-container {
  text-align: center;
  margin: 30px auto;
  padding: 25px;
  background: var(--example-bg);
  border-radius: 16px;
  border: 2px dashed var(--border);
  display: none;
  max-width: 720px;
}

.print-russian-content {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
}

.print-russian-text {
  font-size: 28px;
  color: var(--text);
  font-weight: 600;
  line-height: 1.4;
  margin-bottom: 0;
}

/* ===== –ö–ù–û–ü–ö–ê –ü–û–í–¢–û–†–ê –ê–£–î–ò–û (–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è) ===== */
.repeat-audio-btn {
  background: transparent;
  color: var(--muted);
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  position: relative;
  overflow: hidden;
}

/* –£–±–∏—Ä–∞–µ–º –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–≤–∞–ª –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
.repeat-audio-btn::before {
  display: none;
}

.repeat-audio-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  color: var(--text);
}

.repeat-audio-btn:active {
  transform: scale(0.95);
}

.repeat-audio-btn span {
  position: relative;
  z-index: 1;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ */
.repeat-audio-btn.clicked {
  animation: pulse-animation 0.3s ease;
}

@keyframes pulse-animation {
  0% { transform: scale(1); }
  50% { transform: scale(0.9); }
  100% { transform: scale(1); }
}

/* –í —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
[data-theme="dark"] .repeat-audio-btn {
  color: rgba(255, 255, 255, 0.7);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

[data-theme="dark"] .repeat-audio-btn:hover {
  color: rgba(255, 255, 255, 0.9);
}

.print-hint {
  font-size: 16px;
  color: var(--muted);
  font-style: italic;
  margin-top: 15px;
  text-align: center;
}

.print-input-group {
  position: relative;
  margin-bottom: 20px;
}

.print-input {
  width: 100%;
  padding: 12px 16px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-size: 16px;
  transition: all 0.3s;
  font-family: 'Courier New', monospace;
}

.print-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(219,39,119,0.1);
}

.comparison-result {
  background: var(--card);
  border-radius: 10px;
  padding: 16px;
  margin: 20px 0;
  border: 1px solid var(--border);
  font-family: 'Courier New', monospace;
  font-size: 16px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-wrap: break-word;
  min-height: 80px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ —Å—Ç–∏–ª–µ Anki */
.comparison-user-line, .comparison-correct-line {
  font-family: 'Courier New', monospace;
  font-size: 18px;
  line-height: 1.8;
  margin-bottom: 5px;
  white-space: pre-wrap;
  word-wrap: break-word;
  min-height: 32px;
}

.comparison-arrow {
  text-align: center;
  color: var(--muted);
  font-size: 14px;
  margin: 2px 0;
  opacity: 0.7;
}

.char-anki {
  padding: 2px 3px;
  border-radius: 3px;
  transition: all 0.3s;
  display: inline-block;
  min-width: 10px;
  text-align: center;
  margin: 1px;
}

/* –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞: –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç */
.char-correct {
  background-color: rgba(16, 185, 129, 0.2);
  color: var(--green);
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.char-incorrect {
  background-color: rgba(239, 68, 68, 0.2);
  color: var(--red);
  border: 1px solid rgba(239, 68, 68, 0.3);
  text-decoration: line-through;
}

.char-missing.invisible {
  opacity: 0.3;
  color: #9ca3af;
  border: 1px dashed rgba(156, 163, 175, 0.3);
}

/* –ù–∏–∂–Ω—è—è —Å—Ç—Ä–æ–∫–∞: —ç—Ç–∞–ª–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç */
.char-match {
  color: var(--green);
  font-weight: 600;
}

.char-mismatch {
  background-color: rgba(156, 163, 175, 0.2);
  color: #9ca3af;
  border: 1px solid rgba(156, 163, 175, 0.3);
}

.char-extra {
  width: 10px;
  height: 1px;
  display: inline-block;
}

/* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤ */
.char-anki.space {
  min-width: 8px;
  background-color: rgba(156, 163, 175, 0.1);
  border-radius: 2px;
  position: relative;
}

.char-anki.space::after {
  content: '¬∑';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  opacity: 0.3;
  font-size: 12px;
}

/* –î–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤ */
.char-correct.space {
  background-color: rgba(16, 185, 129, 0.1);
}

.char-correct.space::after {
  color: var(--green);
}

/* –î–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤ */
.char-incorrect.space {
  background-color: rgba(239, 68, 68, 0.1);
}

.char-incorrect.space::after {
  color: var(--red);
}

/* ===== –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ===== */
.side-panel {
  position: fixed;
  top: 102px;
  right: 18px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  box-shadow: var(--shadow);
  display: none;
  z-index: 99;
  width: 320px;
  flex-direction: column;
  gap: 18px;
  opacity: 0;
  transform: translateX(20px);
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.side-panel.open {
  opacity: 1;
  transform: translateX(0);
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.panel-header h3 {
  margin: 0;
  font-size: 16px;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 8px;
}

.close-panel {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.close-panel:hover {
  background: var(--accent);
  color: white;
}

.panel-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.panel-section {
  background: var(--card);
  border-radius: 10px;
  padding: 16px;
  border: 1px solid var(--border);
}

.panel-section h4 {
  margin: 0 0 12px 0;
  font-size: 14px;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===== */
.stats-container {
  background: var(--panel);
  border-radius: 12px;
  padding: 24px;
  margin: 30px auto;
  max-width: 720px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.stats-title {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  font-size: 18px;
  font-weight: 700;
  color: var(--accent);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--card);
  border-radius: 10px;
  padding: 16px;
  border: 1px solid var(--border);
  transition: all 0.3s;
  text-align: center;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.stat-label {
  color: var(--muted);
  font-size: 13px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.stat-value {
  font-size: 24px;
  font-weight: 800;
  color: var(--accent);
  line-height: 1;
}

/* ===== –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø ===== */
@media (max-width: 768px) {
  body {
    padding: 10px;
  }
  
  .main-header {
    padding-top: 60px;
  }
  
  .header-title h1 {
    font-size: 1.5rem;
    margin: 0 0 8px;
  }
  
  .theme-toggle, .settings-toggle {
    top: 10px;
    right: 10px;
    padding: 6px 10px;
    font-size: 12px;
  }
  
  .settings-toggle {
    top: 50px;
  }
  
  .card {
    padding: 16px;
    margin-bottom: 15px;
    border-radius: 12px;
  }
  
  .word-line {
    font-size: 18px;
    margin-top: 20px;
    margin-bottom: 16px;
    padding-bottom: 10px;
    text-align: center;
  }
  
  .word-tags {
    justify-content: center;
    margin-bottom: 10px;
    margin-top: 10px;
  }
  
  .example {
    margin-bottom: 12px;
    padding: 12px 14px;
    border-radius: 8px;
  }
  
  .en {
    font-size: 15px;
    margin-bottom: 6px;
  }
  
  .ru {
    font-size: 13px;
  }
  
  .srs-controls {
    flex-direction: column;
    gap: 10px;
    padding: 0 16px;
  }
  
  .srs-btn {
    width: 100%;
    min-width: auto;
    padding: 14px;
  }
  
  .side-panel {
    top: 70px;
    right: 10px;
    width: calc(100vw - 20px);
    max-width: 300px;
    padding: 16px;
    gap: 14px;
  }
  
  .stats-grid {
    grid-template-columns: 1fr 1fr;
  }
  
  .print-russian-container {
    padding: 20px;
    margin: 20px auto;
  }
  
  .print-russian-text {
    font-size: 22px;
  }
  
  .repeat-audio-btn {
    width: 42px;
    height: 42px;
    font-size: 18px;
  }
  
  .print-russian-content {
    gap: 15px;
  }
  
  .comparison-user-line, .comparison-correct-line {
    font-size: 16px;
  }
}

@media (max-width: 480px) {
  .header-title h1 {
    font-size: 1.3rem;
    padding-top: 10px;
  }
  
  .theme-toggle, .settings-toggle {
    top: 5px;
    right: 5px;
  }
  
  .settings-toggle {
    top: 45px;
  }
  
  .card {
    padding: 12px;
  }
  
  .word-line {
    font-size: 16px;
  }
  
  .example {
    margin-bottom: 10px;
    padding: 10px 12px;
  }
  
  .en {
    font-size: 14px;
  }
  
  .ru {
    font-size: 12px;
  }
  
  .srs-controls {
    flex-direction: column;
    gap: 8px;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .print-russian-text {
    font-size: 20px;
  }
  
  .print-russian-content {
    flex-direction: column;
    gap: 10px;
  }
  
  .repeat-audio-btn {
    width: 44px;
    height: 44px;
    font-size: 19px;
  }
  
  .comparison-user-line, .comparison-correct-line {
    font-size: 15px;
  }
}

/* ===== –†–ï–ñ–ò–ú–´ –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø ===== */
.hide-ru .word-ru,
.hide-ru .ru {
  display: none;
}

.hide-ru .translation {
  display: none;
}

.show-translation-btn {
  display: none;
  padding: 6px 12px;
  margin-top: 8px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s;
  text-align: center;
}

.hide-ru .show-translation-btn {
  display: block;
}

.hide-ru .translation.shown {
  display: block;
}

.show-translation-btn.hidden {
  display: none;
}

.hide-ipa .ipa,
.hide-ipa .example-ipa {
  display: none;
}

.show-syllables .syllables,
.show-syllables .example-syllables {
  display: block;
}
</style>
</head>
<body>
<div class="main-header">
  <div class="header-title">
    <h1>üÉè –†–µ–∂–∏–º –∫–∞—Ä—Ç–æ—á–µ–∫ | SRS</h1>
  </div>
  <div class="header-subtitle">
    –ò–∑—É—á–µ–Ω–∏–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–º–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è–º–∏
  </div>
</div>

<button class="theme-toggle" id="themeBtn" onclick="toggleTheme()">üåô</button>
<button class="settings-toggle" id="settingsBtn" onclick="toggleSettings()">üéôÔ∏è</button>

<div id="flashcard-container">
  <div class="card" id="currentFlashcard">
    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
  </div>
</div>

<div class="print-russian-container" id="printRussianContainer">
  <div class="print-russian-content">
    <div class="print-russian-text" id="printRussianText"></div>
    <button class="repeat-audio-btn" onclick="repeatAudio()" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–∑–≤—É—á–∫—É" id="repeatAudioBtn">
      üîÑ
    </button>
  </div>
  <div class="print-hint">–í–≤–µ–¥–∏—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫—É—é —Ñ—Ä–∞–∑—É, –∫–æ—Ç–æ—Ä—É—é —É—Å–ª—ã—à–∞–ª–∏</div>
</div>

<div class="print-mode-container" id="printModeContainer">
  <div class="print-input-group">
    <input type="text" class="print-input" id="printInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫—É—é —Ñ—Ä–∞–∑—É, –∫–æ—Ç–æ—Ä—É—é —É—Å–ª—ã—à–∞–ª–∏...">
  </div>
  <div class="comparison-result" id="comparisonResult"></div>
</div>

<div class="srs-controls">
  <button class="srs-btn srs-btn-forgot" onclick="markAsForgot()">
    ‚ùå –ù–µ –≤—Å–ø–æ–º–Ω–∏–ª
  </button>
  <button class="srs-btn srs-btn-unsure" onclick="markAsUnsure()">
    ‚ùì –°–æ–º–Ω–µ–≤–∞–ª—Å—è
  </button>
  <button class="srs-btn srs-btn-remember" onclick="markAsRemembered()">
    ‚úÖ –í—Å–ø–æ–º–Ω–∏–ª
  </button>
</div>

<div class="stats-container">
  <div class="stats-title">
    üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑—É—á–µ–Ω–∏—è
  </div>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">
        üìö –í—Å–µ–≥–æ —Å–ª–æ–≤
      </div>
      <div class="stat-value" id="totalWords">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">
        üìÖ –ù–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
      </div>
      <div class="stat-value" id="dueToday">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">
        üéØ –ü—Ä–æ–≥—Ä–µ—Å—Å
      </div>
      <div class="stat-value" id="progressPercent">0%</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">
        üèÜ –í—ã—É—á–µ–Ω–æ
      </div>
      <div class="stat-value" id="learnedWords">0</div>
    </div>
  </div>
  <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
    <button class="srs-btn srs-btn-unsure" style="padding: 10px 20px; min-width: auto;" onclick="exportProgress()">
      üíæ –≠–∫—Å–ø–æ—Ä—Ç
    </button>
    <button class="srs-btn srs-btn-unsure" style="padding: 10px 20px; min-width: auto;" onclick="importProgress()">
      üì• –ò–º–ø–æ—Ä—Ç
    </button>
    <button class="srs-btn srs-btn-forgot" style="padding: 10px 20px; min-width: auto;" onclick="resetProgress()">
      üîÑ –°–±—Ä–æ—Å–∏—Ç—å
    </button>
    <button class="srs-btn srs-btn-remember" style="padding: 10px 20px; min-width: auto;" onclick="goBackToIndex()">
      üìö –ö —Å–ø–∏—Å–∫—É
    </button>
  </div>
</div>

<div class="side-panel" id="sidePanel">
  <div class="panel-header">
    <h3><span>‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <button class="close-panel" onclick="toggleSettings()">√ó</button>
  </div>
  <div class="panel-content">
    <div class="panel-section">
      <h4><span>üîä</span> –û–∑–≤—É—á–∫–∞</h4>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--muted); font-size: 13px;">–ì–æ–ª–æ—Å</label>
          <select id="voiceSelectSide" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 14px;">
            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </select>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--muted); font-size: 13px;">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="rateLabelSide">x1.0</span></label>
          <input id="rateSliderSide" type="range" min="0.5" max="2" step="0.1" value="1" style="width: 100%; accent-color: var(--accent);">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--muted); font-size: 13px;">–í—ã—Å–æ—Ç–∞ —Ç–æ–Ω–∞: <span id="pitchLabelSide">1.0</span></label>
          <input id="pitchSliderSide" type="range" min="0.5" max="1.5" step="0.1" value="1" style="width: 100%; accent-color: var(--accent);">
        </div>
      </div>
    </div>
    <div class="panel-section">
      <h4><span>üëÅÔ∏è</span> –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h4>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <button class="srs-btn srs-btn-unsure" style="width: 100%; padding: 10px;" onclick="toggleTestMode()" id="testBtnSide">
          üß† –°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞
        </button>
        <button class="srs-btn srs-btn-unsure" style="width: 100%; padding: 10px;" onclick="toggleIpaMode()" id="ipaBtnSide">
          üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å IPA
        </button>
        <button class="srs-btn srs-btn-unsure" style="width: 100%; padding: 10px;" onclick="toggleSyllablesMode()" id="syllablesBtnSide">
          üî§ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–≥–∏
        </button>
        <button class="srs-btn srs-btn-unsure" style="width: 100%; padding: 10px;" onclick="togglePrintMode()" id="printModeBtn">
          üìù –†–µ–∂–∏–º –ø–µ—á–∞—Ç–∏
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let allData = [];
let currentCardIndex = 0;
let currentWordData = null;
let printModeActive = false;
let showIpa = false;
let showSyllables = false;
let testMode = false;
let srsProgress = {};
let dueCards = [];
let sessionDeck = [];
let currentSessionIndex = 0;
let VOICES = [];
let currentAudioText = ''; // –¢–µ–∫—Å—Ç –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–∑–≤—É—á–∫–∏ –≤ —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã SRS
const SRS_INTERVALS = [0, 1, 3, 7, 14, 30, 60];

// Storage –∫–ª—é—á–∏
const STORAGE_KEYS = {
  THEME: 'theme',
  SHOW_IPA: 'show_ipa',
  SHOW_SYLLABLES: 'show_syllables',
  TTS_VOICE: 'tts_voice',
  TTS_RATE: 'tts_rate',
  TTS_PITCH: 'tts_pitch',
  PRINT_MODE: 'print_mode'
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async () => {
  await initStorage();
  await loadData();
  loadSettings();
  initVoices();
  initEventListeners();
  loadNextCard();
  updateStats();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
async function initStorage() {
  return new Promise((resolve) => {
    const request = indexedDB.open('srsProgressDB', 1);
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('progress')) {
        db.createObjectStore('progress', { keyPath: 'wordId' });
      }
    };
    
    request.onsuccess = async (event) => {
      const db = event.target.result;
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      const transaction = db.transaction('progress', 'readonly');
      const store = transaction.objectStore('progress');
      const getAllRequest = store.getAll();
      
      getAllRequest.onsuccess = () => {
        srsProgress = Object.fromEntries(getAllRequest.result.map(p => [p.wordId, p]));
        resolve();
      };
      
      getAllRequest.onerror = () => {
        srsProgress = {};
        resolve();
      };
    };
    
    request.onerror = () => {
      srsProgress = {};
      resolve();
    };
  });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
async function loadData() {
  try {
    const response = await fetch('data.json');
    allData = await response.json();
    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allData.length} —Å–ª–æ–≤`);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª data.json');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
function loadSettings() {
  // –¢–µ–º–∞
  const savedTheme = localStorage.getItem(STORAGE_KEYS.THEME);
  if (savedTheme) {
    document.documentElement.setAttribute('data-theme', savedTheme);
    const themeBtn = document.getElementById('themeBtn');
    if (themeBtn) {
      themeBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
  }
  
  // –†–µ–∂–∏–º—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  showIpa = localStorage.getItem(STORAGE_KEYS.SHOW_IPA) === 'true';
  if (showIpa) {
    document.body.classList.remove('hide-ipa');
    const ipaBtnSide = document.getElementById('ipaBtnSide');
    if (ipaBtnSide) {
      ipaBtnSide.textContent = 'üôà –°–∫—Ä—ã—Ç—å IPA';
    }
  } else {
    document.body.classList.add('hide-ipa');
    const ipaBtnSide = document.getElementById('ipaBtnSide');
    if (ipaBtnSide) {
      ipaBtnSide.textContent = 'üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å IPA';
    }
  }
  
  showSyllables = localStorage.getItem(STORAGE_KEYS.SHOW_SYLLABLES) === 'true';
  if (showSyllables) {
    document.body.classList.add('show-syllables');
    const syllablesBtnSide = document.getElementById('syllablesBtnSide');
    if (syllablesBtnSide) {
      syllablesBtnSide.textContent = 'üî§ –°–∫—Ä—ã—Ç—å —Å–ª–æ–≥–∏';
    }
  } else {
    document.body.classList.remove('show-syllables');
    const syllablesBtnSide = document.getElementById('syllablesBtnSide');
    if (syllablesBtnSide) {
      syllablesBtnSide.textContent = 'üî§ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–≥–∏';
    }
  }
  
  // –†–µ–∂–∏–º –ø–µ—á–∞—Ç–∏
  printModeActive = localStorage.getItem(STORAGE_KEYS.PRINT_MODE) === 'true';
  if (printModeActive) {
    const printModeBtn = document.getElementById('printModeBtn');
    if (printModeBtn) {
      printModeBtn.textContent = 'üìù –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º';
    }
  }
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ TTS
  const rateSlider = document.getElementById('rateSliderSide');
  const pitchSlider = document.getElementById('pitchSliderSide');
  if (rateSlider) {
    rateSlider.value = localStorage.getItem(STORAGE_KEYS.TTS_RATE) || 1;
  }
  if (pitchSlider) {
    pitchSlider.value = localStorage.getItem(STORAGE_KEYS.TTS_PITCH) || 1;
  }
  updateTTSLabels();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤
function initVoices() {
  if ('speechSynthesis' in window) {
    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤
    setTimeout(() => {
      const voices = speechSynthesis.getVoices();
      VOICES = voices.filter(v => v.lang.startsWith('en-'));
      
      const voiceSelect = document.getElementById('voiceSelectSide');
      if (voiceSelect) {
        voiceSelect.innerHTML = '';
        
        VOICES.forEach((voice, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = `${voice.name} (${voice.lang})`;
          voiceSelect.appendChild(option);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é –±–µ–∑ –æ–∑–≤—É—á–∫–∏
        const muteOption = document.createElement('option');
        muteOption.value = 'mute';
        muteOption.textContent = 'üîá –ë–µ–∑ –æ–∑–≤—É—á–∫–∏';
        voiceSelect.appendChild(muteOption);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≥–æ–ª–æ—Å
        const savedVoice = localStorage.getItem(STORAGE_KEYS.TTS_VOICE);
        if (savedVoice) {
          voiceSelect.value = savedVoice;
        }
      }
    }, 500);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤
    speechSynthesis.onvoiceschanged = () => {
      const voices = speechSynthesis.getVoices();
      VOICES = voices.filter(v => v.lang.startsWith('en-'));
    };
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function initEventListeners() {
  // –°–ª–∞–π–¥–µ—Ä—ã TTS
  const rateSlider = document.getElementById('rateSliderSide');
  const pitchSlider = document.getElementById('pitchSliderSide');
  const voiceSelect = document.getElementById('voiceSelectSide');
  
  if (rateSlider) {
    rateSlider.addEventListener('input', (e) => {
      localStorage.setItem(STORAGE_KEYS.TTS_RATE, e.target.value);
      updateTTSLabels();
    });
  }
  
  if (pitchSlider) {
    pitchSlider.addEventListener('input', (e) => {
      localStorage.setItem(STORAGE_KEYS.TTS_PITCH, e.target.value);
      updateTTSLabels();
    });
  }
  
  if (voiceSelect) {
    voiceSelect.addEventListener('change', (e) => {
      localStorage.setItem(STORAGE_KEYS.TTS_VOICE, e.target.value);
    });
  }
  
  // –í–≤–æ–¥ –≤ —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏
  const printInput = document.getElementById('printInput');
  if (printInput) {
    printInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        checkPrintAnswer();
      }
    });
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫ TTS
function updateTTSLabels() {
  const rateSlider = document.getElementById('rateSliderSide');
  const pitchSlider = document.getElementById('pitchSliderSide');
  const rateLabel = document.getElementById('rateLabelSide');
  const pitchLabel = document.getElementById('pitchLabelSide');
  
  if (rateSlider && rateLabel) {
    rateLabel.textContent = `x${parseFloat(rateSlider.value).toFixed(1)}`;
  }
  
  if (pitchSlider && pitchLabel) {
    pitchLabel.textContent = parseFloat(pitchSlider.value).toFixed(1);
  }
}

// –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
function createSession() {
  dueCards = calculateDueCards();
  sessionDeck = shuffleArray([...dueCards]);
  currentSessionIndex = 0;
}

// –†–∞—Å—á–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
function calculateDueCards() {
  const now = Date.now();
  const dueWords = [];
  
  allData.forEach(word => {
    const progress = srsProgress[word.word];
    if (!progress || progress.nextReview <= now) {
      dueWords.push(word);
    }
  });
  
  return dueWords;
}

// –°–±—Ä–æ—Å –ø–æ–ª—è –≤–≤–æ–¥–∞ –≤ —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏
function resetPrintInput() {
  const input = document.getElementById('printInput');
  const resultDiv = document.getElementById('comparisonResult');
  
  if (input) {
    input.value = '';
    input.disabled = false;
    input.style.opacity = '1';
    input.style.cursor = 'text';
  }
  
  if (resultDiv) {
    resultDiv.innerHTML = '';
  }
  
  // –£–¥–∞–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
  if (currentWordData) {
    delete currentWordData.lastPrintResult;
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏
function loadNextCard() {
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—á–∞—Ç–∏ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
  if (printModeActive) {
    resetPrintInput();
  }
  
  // –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –ø—É—Å—Ç–∞, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
  if (sessionDeck.length === 0) {
    createSession();
  }
  
  // –ï—Å–ª–∏ –≤ —Å–µ—Å—Å–∏–∏ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫
  if (sessionDeck.length === 0) {
    showCompletionMessage();
    return;
  }
  
  // –ï—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ —Å–µ—Å—Å–∏–∏, –Ω–∞—á–∏–Ω–∞–µ–º —Å–Ω–∞—á–∞–ª–∞
  if (currentSessionIndex >= sessionDeck.length) {
    currentSessionIndex = 0;
  }
  
  currentWordData = sessionDeck[currentSessionIndex];
  currentCardIndex = allData.findIndex(item => item.word === currentWordData.word) + 1;
  
  renderFlashcard();
  
  // –í —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–∑–≤—É—á–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–∏–º–µ—Ä
  if (printModeActive && currentWordData.examples && currentWordData.examples.length > 0) {
    const firstExample = currentWordData.examples[0];
    currentAudioText = firstExample.en; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–∑–≤—É—á–∫–∏
    speakText(currentAudioText);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ —ç—Ç–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞
    const printRussianText = document.getElementById('printRussianText');
    if (printRussianText) {
      printRussianText.textContent = firstExample.ru;
    }
  } else if (printModeActive) {
    // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∏–º–µ—Ä–æ–≤, –æ–∑–≤—É—á–∏–≤–∞–µ–º —Å–ª–æ–≤–æ
    currentAudioText = currentWordData.word; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–∑–≤—É—á–∫–∏
    speakText(currentAudioText);
    const printRussianText = document.getElementById('printRussianText');
    if (printRussianText) {
      printRussianText.textContent = currentWordData.translation;
    }
  } else {
    // –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –æ–∑–≤—É—á–∏–≤–∞–µ–º —Å–ª–æ–≤–æ
    speakText(currentWordData.word);
  }
  
  currentSessionIndex++;
}

// –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–∑–≤—É—á–∫—É (—Ä–µ–∂–∏–º –ø–µ—á–∞—Ç–∏)
function repeatAudio() {
  if (currentAudioText) {
    speakText(currentAudioText);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∫–ª–∏–∫–∞
    const repeatBtn = document.getElementById('repeatAudioBtn');
    if (repeatBtn) {
      repeatBtn.classList.add('clicked');
      setTimeout(() => {
        repeatBtn.classList.remove('clicked');
      }, 300);
    }
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏
function checkPrintAnswer() {
  const input = document.getElementById('printInput');
  const resultDiv = document.getElementById('comparisonResult');
  
  if (!currentWordData || !currentWordData.examples || currentWordData.examples.length === 0) {
    return;
  }
  
  const userAnswer = input.value.trim();
  const correctAnswer = currentWordData.examples[0].en;
  
  // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏
  const comparison = compareStringsAnkiStyle(userAnswer, correctAnswer);
  if (resultDiv) {
    resultDiv.innerHTML = comparison;
  }
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
  if (input) {
    input.disabled = true;
    input.style.opacity = '0.7';
    input.style.cursor = 'not-allowed';
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  currentWordData.lastPrintResult = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
}

// –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ —Å—Ç–∏–ª–µ Anki (–¥–≤–µ —Å—Ç—Ä–æ–∫–∏: –≤–µ—Ä—Ö–Ω—è—è - –≤–≤–µ–¥–µ–Ω–Ω–∞—è, –Ω–∏–∂–Ω—è—è - —ç—Ç–∞–ª–æ–Ω–Ω–∞—è)
function compareStringsAnkiStyle(user, correct) {
  const userChars = user.split('');
  const correctChars = correct.split('');
  
  let userLine = '';
  let correctLine = '';
  
  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –¥–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
  const maxLength = Math.max(userChars.length, correctChars.length);
  
  // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: –≤–≤–µ–¥–µ–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  userLine = '<div class="comparison-user-line">';
  
  for (let i = 0; i < maxLength; i++) {
    const userChar = userChars[i] || '';
    const correctChar = correctChars[i] || '';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–∏–º–≤–æ–ª –ø—Ä–æ–±–µ–ª–æ–º
    const isSpace = userChar === ' ' || correctChar === ' ';
    const spaceClass = isSpace ? ' space' : '';
    
    if (userChar && correctChar && userChar.toLowerCase() === correctChar.toLowerCase()) {
      // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª
      userLine += `<span class="char-anki char-correct${spaceClass}">${userChar === ' ' ? ' ' : userChar}</span>`;
    } else if (userChar) {
      // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª
      userLine += `<span class="char-anki char-incorrect${spaceClass}">${userChar === ' ' ? ' ' : userChar}</span>`;
    } else {
      // –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–≤–µ–ª)
      // –î–ª—è –ø—Ä–æ–±–µ–ª–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–∏–º—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
      if (correctChar === ' ') {
        userLine += `<span class="char-anki char-missing space"> </span>`;
      } else {
        userLine += `<span class="char-anki char-missing invisible">${correctChar}</span>`;
      }
    }
  }
  userLine += '</div>';
  
  // –°—Ç—Ä–µ–ª–∫–∞-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
  const arrow = '<div class="comparison-arrow">‚Üì</div>';
  
  // –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: —ç—Ç–∞–ª–æ–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞
  correctLine = '<div class="comparison-correct-line">';
  
  for (let i = 0; i < maxLength; i++) {
    const userChar = userChars[i] || '';
    const correctChar = correctChars[i] || '';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–∏–º–≤–æ–ª –ø—Ä–æ–±–µ–ª–æ–º
    const isSpace = correctChar === ' ';
    const spaceClass = isSpace ? ' space' : '';
    
    if (userChar && correctChar && userChar.toLowerCase() === correctChar.toLowerCase()) {
      // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≤–≤–µ–¥–µ–Ω–Ω—ã–º)
      correctLine += `<span class="char-anki char-match${spaceClass}">${correctChar === ' ' ? ' ' : correctChar}</span>`;
    } else if (correctChar) {
      // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª –∏–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
      correctLine += `<span class="char-anki char-mismatch${spaceClass}">${correctChar === ' ' ? ' ' : correctChar}</span>`;
    } else {
      // –õ–∏—à–Ω–∏–π —Å–∏–º–≤–æ–ª, –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–≤ –Ω–∏–∂–Ω–µ–π —Å—Ç—Ä–æ–∫–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
      correctLine += `<span class="char-anki char-extra"></span>`;
    }
  }
  correctLine += '</div>';
  
  return userLine + arrow + correctLine;
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ (–æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º)
function renderFlashcard() {
  const card = document.getElementById('currentFlashcard');
  const printRussianContainer = document.getElementById('printRussianContainer');
  const printModeContainer = document.getElementById('printModeContainer');
  
  if (!currentWordData) return;
  
  const progress = srsProgress[currentWordData.word] || { level: 0 };
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
  if (printModeActive) {
    if (printRussianContainer) {
      printRussianContainer.style.display = 'block';
    }
    if (printModeContainer) {
      printModeContainer.style.display = 'block';
    }
    if (card) {
      card.style.display = 'none';
    }
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    const printInput = document.getElementById('printInput');
    const comparisonResult = document.getElementById('comparisonResult');
    if (printInput) {
      printInput.value = '';
      printInput.focus();
    }
    if (comparisonResult) {
      comparisonResult.innerHTML = '';
    }
    
    return; // –ù–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –æ–±—ã—á–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É –≤ —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏
  } else {
    if (printRussianContainer) {
      printRussianContainer.style.display = 'none';
    }
    if (printModeContainer) {
      printModeContainer.style.display = 'none';
    }
    if (card) {
      card.style.display = 'block';
    }
  }
  
  // –°–æ–∑–¥–∞–µ–º HTML –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ (–∫–∞–∫ –≤ index.html)
  let html = `
    <div class="card-header">
      <div class="session-info">
        <span class="session-current">${currentSessionIndex}</span> –∏–∑ <span>${sessionDeck.length}</span>
        <div class="srs-level level-${progress.level}">–£—Ä–æ–≤–µ–Ω—å ${progress.level}</div>
      </div>
      <div class="card-index">
        ${createServiceIcons()}
        <span class="index-num">${currentCardIndex}</span>
      </div>
    </div>
  `;
  
  // –¢–µ–≥–∏
  if (currentWordData.tags && currentWordData.tags.length > 0) {
    html += `<div class="word-tags">`;
    currentWordData.tags.forEach(tag => {
      html += `<span class="word-tag">${tag}</span>`;
    });
    html += `</div>`;
  }
  
  // –¢–µ–º–∞
  if (currentWordData.theme) {
    html += `<div class="word-tags"><span class="word-tag">${currentWordData.theme}</span></div>`;
  }
  
  // –û—Å–Ω–æ–≤–Ω–æ–µ —Å–ª–æ–≤–æ
  html += `
    <div class="word-line">
      <span class="word-en" data-speak="${currentWordData.word}">${currentWordData.word}</span>
  `;
  
  // –°–ª–æ–≥–∏
  if (showSyllables && currentWordData.syllables) {
    html += `<div class="syllables">`;
    const syllables = currentWordData.syllables.split('¬∑');
    syllables.forEach((syllable, i) => {
      const isStressed = i === currentWordData.stress;
      html += `<span class="syllable ${isStressed ? 'stressed' : ''}">${syllable}</span>`;
    });
    html += `</div>`;
  }
  
  // IPA –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–ª–æ–≤–∞
  if (currentWordData.ipa) {
    html += `<div class="ipa">${currentWordData.ipa}</div>`;
  }
  
  // –†—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
  html += `<span class="word-ru translation">${currentWordData.translation}</span>`;
  html += `<button class="show-translation-btn" onclick="showTranslation(this)">Show</button>`;
  html += `</div>`;
  
  // –ü—Ä–∏–º–µ—Ä—ã
  if (currentWordData.examples && currentWordData.examples.length > 0) {
    html += `<div class="examples">`;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 2 –ø—Ä–∏–º–µ—Ä–∞
    currentWordData.examples.slice(0, 2).forEach(example => {
      html += `
        <div class="example">
          <div class="en" data-speak="${example.en}">${example.en}</div>
      `;
      
      // IPA –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
      if (example.ipa) {
        html += `<div class="ipa">${example.ipa}</div>`;
      }
      
      // –°–ª–æ–≥–∏ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
      if (showSyllables && example.syllables) {
        html += `<div class="example-syllables">`;
        const exampleSyllables = example.syllables.split('¬∑');
        exampleSyllables.forEach((syllable, i) => {
          const isStressed = example.stress && example.stress.includes(i);
          html += `<span class="syllable ${isStressed ? 'stressed' : ''}">${syllable}</span>`;
        });
        html += `</div>`;
      }
      
      // –†—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
      html += `<div class="ru translation">${example.ru}</div>`;
      html += `<button class="show-translation-btn" onclick="showTranslation(this)">Show</button>`;
      html += `</div>`;
    });
    
    html += `</div>`;
  }
  
  if (card) {
    card.innerHTML = html;
  }
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ–∂–∏–º —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏
  if (testMode) {
    document.body.classList.add('hide-ru');
  } else {
    document.body.classList.remove('hide-ru');
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ–∑–≤—É—á–∫–∏
  setTimeout(() => {
    document.querySelectorAll('.word-en, .en').forEach(el => {
      el.addEventListener('click', (e) => handleSpeakClick(el, e));
      el.addEventListener('dblclick', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const word = selectWordFromEvent(e, el);
        speakText(word);
      });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤
    document.querySelectorAll('.word-ru, .ru')
      .forEach(el => el.addEventListener('click', () => selectNode(el)));
  }, 100);
}

// –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
function selectNode(el) {
  const range = document.createRange();
  range.selectNodeContents(el);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
}

// –í—ã–±–æ—Ä —Å–ª–æ–≤–∞ –∏–∑ —Å–æ–±—ã—Ç–∏—è
function selectWordFromEvent(event, element) {
  const text = element.textContent;
  const node = element.firstChild;
  if (!node || node.nodeType !== Node.TEXT_NODE) return text.trim();
  
  // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
  const firstWord = text.split(/\s+/)[0];
  return firstWord;
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∏–∫–æ–Ω–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ (–∫–∞–∫ –≤ index.html)
function createServiceIcons() {
  if (!currentWordData) return '';
  
  const word = encodeURIComponent(currentWordData.word);
  const wordPlus = currentWordData.word.replace(/ /g, '+');
  const wordUnder = currentWordData.word.replace(/ /g, '_');
  
  const isMobile = window.innerWidth <= 768;
  
  const services = [
    { url: `https://youglish.com/pronounce/${wordUnder}/english`, icon: 'img/youglish.png', title: 'YouGlish' },
    { url: `https://www.playphrase.me/#/search?q=${wordPlus}&language=en`, icon: 'img/playphrase.png', title: 'PlayPhrase' },
    { url: `https://translate.yandex.ru/?source_lang=en&target_lang=ru&text=${word}`, icon: 'img/yandex.png', title: '–Ø–Ω–¥–µ–∫—Å –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫' },
    { url: `https://www.translate.ru/–∫–æ–Ω—Ç–µ–∫—Å—Ç—ã/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π-—Ä—É—Å—Å–∫–∏–π/${word}`, icon: 'img/translateru.png', title: 'Translate.ru' },
    { url: `https://en.kartaslov.ru/–ø–µ—Ä–µ–≤–æ–¥-–≤-–∫–æ–Ω—Ç–µ–∫—Å—Ç–µ/${wordPlus}`, icon: 'img/kartaslov.png', title: 'Kartaslov' },
    { url: `https://context.reverso.net/–ø–µ—Ä–µ–≤–æ–¥/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π-—Ä—É—Å—Å–∫–∏–π/${wordPlus}`, icon: 'img/reverso.png', title: 'Reverso Context' },
    { url: `https://wooordhunt.ru/word/${word}`, icon: 'img/wooordhunt.png', title: 'WooordHunt' },
    { url: `https://ru.forvo.com/search/${word}/`, icon: 'img/forvo.png', title: 'Forvo' },
    { url: `https://yandex.ru/images/search?text=${word}`, icon: 'img/yandex-images.png', title: '–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∏–Ω–∫–∏' }
  ];
  
  let html = '';
  
  if (isMobile) {
    html += '<div>';
    services.slice(0, 4).forEach(service => {
      html += `
        <a href="${service.url}" target="_blank" title="${service.title}">
          <img src="${service.icon}" alt="${service.title}" class="service-icon">
        </a>
      `;
    });
    html += '</div>';
  } else {
    services.forEach(service => {
      html += `
        <a href="${service.url}" target="_blank" title="${service.title}">
          <img src="${service.icon}" alt="${service.title}" class="service-icon">
        </a>
      `;
    });
  }
  
  return html;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –æ–∑–≤—É—á–∫–∏
function handleSpeakClick(element, event) {
  event.stopPropagation();
  const text = element.dataset.speak;
  if (text) {
    speakText(text);
  }
}

// –û–∑–≤—É—á–∫–∞ —Ç–µ–∫—Å—Ç–∞
function speakText(text) {
  if (!('speechSynthesis' in window)) {
    console.warn('Speech synthesis not supported');
    return;
  }
  
  const voiceSelect = document.getElementById('voiceSelectSide');
  if (voiceSelect && voiceSelect.value === 'mute') return;
  
  speechSynthesis.cancel();
  
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'en-US';
  
  const rateSlider = document.getElementById('rateSliderSide');
  const pitchSlider = document.getElementById('pitchSliderSide');
  
  if (rateSlider) {
    utterance.rate = parseFloat(rateSlider.value);
  }
  if (pitchSlider) {
    utterance.pitch = parseFloat(pitchSlider.value);
  }
  
  if (voiceSelect && voiceSelect.value !== 'mute' && VOICES[voiceSelect.value]) {
    utterance.voice = VOICES[voiceSelect.value];
  }
  
  speechSynthesis.speak(utterance);
}

// SRS —Ñ—É–Ω–∫—Ü–∏–∏
function markAsRemembered() {
  // –í —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏ —É—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
  if (printModeActive && currentWordData && currentWordData.lastPrintResult !== undefined) {
    // –ï—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏ –∏ –±—ã–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    updateSRSProgress(currentWordData.lastPrintResult, currentWordData.lastPrintResult ? false : true);
  } else {
    // –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –∏–ª–∏ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–µ—á–∞—Ç–∏
    updateSRSProgress(true);
  }
  loadNextCard();
  updateStats();
  resetPrintInput();
}

function markAsUnsure() {
  // –í —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏ –≤—Å–µ–≥–¥–∞ –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ "—Å–æ–º–Ω–µ–≤–∞–ª—Å—è", –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  updateSRSProgress(false, true);
  loadNextCard();
  updateStats();
  resetPrintInput();
}

function markAsForgot() {
  // –í —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏ –≤—Å–µ–≥–¥–∞ –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ "–Ω–µ –≤—Å–ø–æ–º–Ω–∏–ª", –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  updateSRSProgress(false, false);
  loadNextCard();
  updateStats();
  resetPrintInput();
}

function updateSRSProgress(remembered, unsure = false) {
  if (!currentWordData) return;
  
  const wordId = currentWordData.word;
  let progress = srsProgress[wordId] || {
    level: 0,
    lastReview: Date.now(),
    nextReview: Date.now(),
    printModeCount: 0, // –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø–µ—á–∞—Ç–∏
    printModeCorrect: 0 // –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏
  };
  
  // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–∂–∏–º –ø–µ—á–∞—Ç–∏, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–µ—á–∞—Ç–∏
  if (printModeActive) {
    progress.printModeCount = (progress.printModeCount || 0) + 1;
    if (remembered && !unsure) {
      progress.printModeCorrect = (progress.printModeCorrect || 0) + 1;
    }
  }
  
  if (remembered) {
    progress.level = Math.min(progress.level + 1, SRS_INTERVALS.length - 1);
  } else if (unsure) {
    progress.level = Math.max(0, progress.level - 1);
  } else {
    progress.level = 0;
  }
  
  const days = SRS_INTERVALS[progress.level];
  progress.lastReview = Date.now();
  progress.nextReview = Date.now() + (days * 24 * 60 * 60 * 1000);
  
  srsProgress[wordId] = progress;
  saveProgress(wordId, progress);
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
async function saveProgress(wordId, progress) {
  return new Promise((resolve) => {
    const request = indexedDB.open('srsProgressDB', 1);
    
    request.onsuccess = (event) => {
      const db = event.target.result;
      const transaction = db.transaction('progress', 'readwrite');
      const store = transaction.objectStore('progress');
      store.put({ wordId, ...progress });
      
      transaction.oncomplete = resolve;
      transaction.onerror = () => {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞');
        resolve();
      };
    };
    
    request.onerror = () => {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
      resolve();
    };
  });
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥
function showTranslation(btn) {
  const translation = btn.previousElementSibling;
  if (translation && translation.classList.contains('translation')) {
    translation.classList.add('shown');
    btn.classList.add('hidden');
  }
}

// –†–µ–∂–∏–º –ø–µ—á–∞—Ç–∏
function togglePrintMode() {
  printModeActive = !printModeActive;
  const btn = document.getElementById('printModeBtn');
  
  if (btn) {
    if (printModeActive) {
      btn.textContent = 'üìù –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º';
    } else {
      btn.textContent = 'üìù –†–µ–∂–∏–º –ø–µ—á–∞—Ç–∏';
    }
  }
  
  localStorage.setItem(STORAGE_KEYS.PRINT_MODE, printModeActive);
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—á–∞—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞
  resetPrintInput();
  
  loadNextCard();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStats() {
  const totalWords = allData.length;
  const dueToday = calculateDueCards().length;
  
  // –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É—Ä–æ–≤–Ω—è–º
  let newWords = 0;
  let learnedWords = 0;
  let totalProgress = 0;
  
  Object.values(srsProgress).forEach(progress => {
    if (progress.level === 0) newWords++;
    if (progress.level >= 3) learnedWords++;
    totalProgress += progress.level;
  });
  
  const averageProgress = Object.keys(srsProgress).length > 0 
    ? Math.round((totalProgress / (Object.keys(srsProgress).length * 6)) * 100)
    : 0;
  
  const overallProgress = totalWords > 0 ? Math.round((learnedWords / totalWords) * 100) : 0;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
  const totalWordsEl = document.getElementById('totalWords');
  const dueTodayEl = document.getElementById('dueToday');
  const progressPercentEl = document.getElementById('progressPercent');
  const learnedWordsEl = document.getElementById('learnedWords');
  
  if (totalWordsEl) totalWordsEl.textContent = totalWords;
  if (dueTodayEl) dueTodayEl.textContent = dueToday;
  if (progressPercentEl) progressPercentEl.textContent = `${averageProgress}%`;
  if (learnedWordsEl) learnedWordsEl.textContent = learnedWords;
}

// –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
function showCompletionMessage() {
  const card = document.getElementById('currentFlashcard');
  const printRussianContainer = document.getElementById('printRussianContainer');
  const printModeContainer = document.getElementById('printModeContainer');
  const srsControls = document.querySelector('.srs-controls');
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—á–∞—Ç–∏
  resetPrintInput();
  
  if (printModeActive) {
    if (printRussianContainer) {
      printRussianContainer.style.display = 'none';
    }
    if (printModeContainer) {
      printModeContainer.style.display = 'none';
    }
  }
  
  if (card) {
    card.style.display = 'block';
    card.innerHTML = `
      <div style="text-align: center; padding: 40px 32px;">
        <div style="font-size: 48px; margin-bottom: 24px;">üéâ</div>
        <h2 style="margin-bottom: 16px; color: var(--accent);">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</h2>
        <p style="color: var(--muted); margin-bottom: 32px; font-size: 18px;">
          –í—ã –ø–æ–≤—Ç–æ—Ä–∏–ª–∏ –≤—Å–µ —Å–ª–æ–≤–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.<br>
          –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Å–µ—Å—Å–∏–∏.
        </p>
        <button class="srs-btn srs-btn-remember" onclick="startNewSession()" style="margin: 0 auto;">
          –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
        </button>
      </div>
    `;
  }
  
  if (srsControls) {
    srsControls.style.display = 'none';
  }
}

// –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
function startNewSession() {
  createSession();
  const srsControls = document.querySelector('.srs-controls');
  if (srsControls) {
    srsControls.style.display = 'flex';
  }
  loadNextCard();
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–º–æ–π
function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem(STORAGE_KEYS.THEME, next);
  
  const btn = document.getElementById('themeBtn');
  if (btn) {
    btn.textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  }
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
function toggleSettings() {
  const panel = document.getElementById('sidePanel');
  if (panel) {
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
      panel.style.display = 'flex';
    } else {
      setTimeout(() => {
        panel.style.display = 'none';
      }, 300);
    }
  }
}

function toggleTestMode() {
  testMode = !testMode;
  const btn = document.getElementById('testBtnSide');
  if (btn) {
    btn.textContent = testMode ? 'üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã' : 'üß† –°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞';
  }
  renderFlashcard();
}

function toggleIpaMode() {
  showIpa = !showIpa;
  
  if (showIpa) {
    document.body.classList.remove('hide-ipa');
  } else {
    document.body.classList.add('hide-ipa');
  }
  
  const ipaBtnSide = document.getElementById('ipaBtnSide');
  if (ipaBtnSide) {
    ipaBtnSide.textContent = showIpa ? 'üôà –°–∫—Ä—ã—Ç—å IPA' : 'üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å IPA';
  }
  
  localStorage.setItem(STORAGE_KEYS.SHOW_IPA, showIpa);
  renderFlashcard();
}

function toggleSyllablesMode() {
  showSyllables = !showSyllables;
  
  if (showSyllables) {
    document.body.classList.add('show-syllables');
  } else {
    document.body.classList.remove('show-syllables');
  }
  
  const syllablesBtnSide = document.getElementById('syllablesBtnSide');
  if (syllablesBtnSide) {
    syllablesBtnSide.textContent = showSyllables ? 'üî§ –°–∫—Ä—ã—Ç—å —Å–ª–æ–≥–∏' : 'üî§ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–≥–∏';
  }
  
  localStorage.setItem(STORAGE_KEYS.SHOW_SYLLABLES, showSyllables);
  renderFlashcard();
}

// –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
async function exportProgress() {
  try {
    const progressData = {
      version: 1,
      exportedAt: Date.now(),
      progress: srsProgress
    };
    
    const blob = new Blob([JSON.stringify(progressData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `srs-progress-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showMessage('–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!', 'success');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
    showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞', 'error');
  }
}

async function importProgress() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    
    reader.onload = async (event) => {
      try {
        const content = JSON.parse(event.target.result);
        
        if (content.progress) {
          srsProgress = content.progress;
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ IndexedDB
          const request = indexedDB.open('srsProgressDB', 1);
          
          request.onsuccess = (event) => {
            const db = event.target.result;
            const transaction = db.transaction('progress', 'readwrite');
            const store = transaction.objectStore('progress');
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ
            store.clear();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤–æ–µ
            Object.entries(srsProgress).forEach(([wordId, progress]) => {
              store.put({ wordId, ...progress });
            });
            
            transaction.oncomplete = () => {
              updateStats();
              createSession();
              loadNextCard();
              showMessage('–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!', 'success');
            };
            
            transaction.onerror = () => {
              showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞', 'error');
            };
          };
        } else {
          showMessage('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞', 'error');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞', 'error');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

function resetProgress() {
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å SRS? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
    const request = indexedDB.open('srsProgressDB', 1);
    
    request.onsuccess = (event) => {
      const db = event.target.result;
      const transaction = db.transaction('progress', 'readwrite');
      const store = transaction.objectStore('progress');
      store.clear();
      
      transaction.oncomplete = () => {
        srsProgress = {};
        updateStats();
        createSession();
        loadNextCard();
        showMessage('–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω!', 'success');
      };
    };
  }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function goBackToIndex() {
  window.location.href = 'index.html';
}

function showError(message) {
  const card = document.getElementById('currentFlashcard');
  if (card) {
    card.innerHTML = `
      <div style="text-align: center; padding: 40px 32px;">
        <div style="color: var(--red); font-size: 48px; margin-bottom: 24px;">‚ö†Ô∏è</div>
        <h3 style="margin-bottom: 16px; color: var(--accent);">–û—à–∏–±–∫–∞</h3>
        <p style="color: var(--muted); margin-bottom: 24px;">${message}</p>
        <button class="srs-btn srs-btn-remember" onclick="location.reload()">
          –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
        </button>
      </div>
    `;
  }
}

function showMessage(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${type === 'success' ? 'var(--green)' : 'var(--red)'};
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    z-index: 10000;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
  `;
  
  notification.innerHTML = `
    <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
    <span>${message}</span>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(-50%) translateY(-20px)';
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}
</script>
</body>
</html>